---
title: "Ozflux Site Budget"
output:
    html_document:
        toc: true
        theme: united
        css: ozflux-benchmarks.css
        self_contained: true
params:
  repo: "~/code/lpj-guess/dave"
  data_dir: "~/code/lpj-guess/scripts/ozflux-lpjg/data"
  source_id: "new"
  source_label: "MRS-NewCode"
  site: "CumberlandPlain"
  pft: "MRS"
  description: "A description of the simulations. If you're seeing this in a rendered .html file, then someone forgot to set the description when rendering the document. This can be done with `rmarkdown::render(\"site_budget.rmd\", params = list(description = \"A description of the simulations\"))`"
  aspect_ratio: 0.6
  image_fmt: "svg"
  fig_width: 20
  dpi: 96
  retina: 2
  fig_align: "center"
  out_width: "100%"
---

```{r setup, include=FALSE, echo=FALSE}
library("daveanalysis")
library("ggpubr")
library("tidyr")
library("lubridate")
library("plotly")
library("dplyr")

# Read parameters from the Rmd 'params:' header (with defaults for ad-hoc runs)
repo <- params$repo
source_id <- params$source_id
source_label <- params$source_label
site <- params$site
pft <- params$pft

# Define the data source from parameters
# This will throw if source directory doesn't exist.
src <- defineSource(source_id, source_label, dir = repo, format = OZFLUX)

# knitr options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      out.width = params$out_width,
                      fig.asp = params$aspect_ratio,
                      dev = params$image_fmt,
                      dpi = params$dpi,
                      fig.retina = params$retina,
                      fig.align = params$fig_align,
                      fig.width = params$fig_width)

dave_config(log_level = 0)

# Set ggplot theme.
theme_set(theme_bw(base_size = 16))

daveanalysis:::register_supplementary_observations(params$data_dir)
```

```{r helper_functions}
read_data <- function(vars, layers = NULL, ...) {
    data <- daveanalysis::read_data(src, vars, site, layers = layers, ...)
    data <- data@data
    # Remove Lon/Lat columns, which are redundant when dealing with one site.
    data <- select(data, -c("Lon", "Lat"))
    return(data)
}

calc_date <- function(year, day) {
    return(as.Date(paste0(year, "-", day), format = "%Y-%j"))
}

som_pools <- c("SURFSTRUCT", "SOILSTRUCT", "SOILMICRO", "SURFHUMUS",
               "SURFMICRO", "SURFMETA", "SURFFWD", "SURFCWD", "SOILMETA",
               "SLOWSOM", "PASSIVESOM", "total")
plot_sompool <- function(file, ylab, title, xlab = "Date") {
    data <- read_data(file, layers = som_pools)
    if ("Day" %in% names(data)) {
        data$date <- calc_date(data$Year, data$Day)
    } else {
        data$date <- data$Year
        if (missing(xlab)) {
            xlab <- "Year"
        }
    }
    data_long <- pivot_longer(data, cols = som_pools, names_to = "pool",
                              values_to = "value")

    # Convert from kg -> g
    data_long$value <- data_long$value * 1000
    data_long$pool <- factor(data_long$pool, levels = sort(som_pools))
    ggplot(data_long) +
        geom_line(aes(x = date, y = value, color = pool)) +
        facet_wrap(~ pool, scales = "free_y") +
        xlab(xlab) +
        ylab(ylab) +
        labs(title = paste(site, title)) +
        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
}

read_cton_live <- function(pool) {
    cmass <- read_data(paste0("dave_cmass_", pool))
    nmass <- read_data(paste0("dave_nmass_", pool))

    cton_min <- read_data(paste0("dave_cton_", pool, "_min"))
    cton_max <- read_data(paste0("dave_cton_", pool, "_max"))

    cton_min <- min(cton_min[[pft]])
    cton_max <- max(cton_max[[pft]])

    df <- merge(cmass, nmass, by = c("Year", "Day"))
    df <- setNames(df, c("Year", "Day", "cmass", "nmass"))

    df$cton_min <- cton_min
    df$cton_max <- cton_max

    df$cton <- df$cmass / df$nmass
    df$nmass_min <- df$cmass / df$cton_max
    df$nmass_max <- df$cmass / df$cton_min
    df$Date <- calc_date(df$Year, df$Day)
    return(df)
}

plot_against <- function(x, y, xname, yname, xunits, yunits,
                         ignored_layers = NULL, log_x = FALSE,
                         nrow = 2, scales = "free",
                         xlim = NULL, ylim = NULL) {
    xdata <- read_data(x)
    ydata <- read_data(y)

    # Get list of observed source names.
    std_ignore <- c("Year", "Day", "Site")
    std_x_ignore <- intersect(std_ignore, names(xdata))
    pred_x_layers <- src@name
    if (!(pred_x_layers) %in% names(xdata)) {
        pred_x_layers <- setdiff(names(xdata), std_x_ignore)
    }
    obs_x_layers <- setdiff(names(xdata),
                            intersect(names(xdata),
                                      c(std_x_ignore, pred_x_layers)))
    if (length(obs_x_layers) == 0 && length(pred_x_layers) == 1) {
        # Only 1 x layer.
        obs_x_layers <- pred_x_layers
    }
    std_y_ignore <- intersect(std_ignore, names(ydata))
    pred_y_layers <- src@name
    if (!(pred_y_layers) %in% names(ydata)) {
        pred_y_layers <- setdiff(names(ydata), std_y_ignore)
    }
    obs_y_layers <- setdiff(names(ydata),
                            intersect(names(ydata),
                                      c(std_y_ignore, pred_y_layers)))

    if (!is.null(ignored_layers)) {
        ignored_x <- intersect(ignored_layers, obs_x_layers)
        obs_x_layers <- setdiff(obs_x_layers, ignored_x)

        ignored_y <- intersect(ignored_layers, obs_y_layers)
        obs_y_layers <- setdiff(obs_y_layers, ignored_y)
    }

    # Convert x to long format and filter out NA values.
    x_long <- pivot_longer(xdata, cols = c(obs_x_layers, pred_x_layers),
                           names_to = "source", values_to = "x")
    # x_long <- x_long[complete.cases(x_long), ]

    # Convert y to long format and filter out NA values.
    y_long <- pivot_longer(ydata, cols = c(obs_y_layers, pred_y_layers),
                           names_to = "source", values_to = "y")
    # y_long <- y_long[complete.cases(y_long), ]

    by <- c("Year", "Day", "Site")
    by <- intersect(by, names(x_long))
    by <- intersect(by, names(y_long))
    data <- merge(x_long, y_long, by = by,
                  suffixes = c("_x", "_y"))
    data$date <- calc_date(data$Year, data$Day)
    data$month <- as.numeric(format(data$date, "%m"))
    data$month <- factor(data$month, levels = 1:12, labels = month.abb)

    # Predicted vs Predicted
    # Note: pred_*_layers is scalar (length=1) for now, for single-simulation
    # plots. This may change in the future, in which case we would need %in%.
    pred_df <- dplyr::filter(
        data,
        source_x == pred_x_layers,
        source_y == pred_y_layers
    )

    # Observed y vs Observed x (all combinations).
    obs_df <- dplyr::filter(data,
                            source_x %in% obs_x_layers,
                            source_y %in% obs_y_layers)

    # Build a single combined data frame that includes Predicted vs Predicted
    # as just another "combo", so we can facet in one plot.
    pred_df <- pred_df %>%
        dplyr::mutate(combo = paste0("Predicted ", yname, " vs Predicted ",
                                     xname))

    all_df <- pred_df
    if (nrow(obs_df) > 0) {
        obs_df <- obs_df %>% dplyr::mutate(combo = paste0(source_y, " vs ",
                                                          source_x))
        all_df <- dplyr::bind_rows(pred_df, obs_df)
    }

    p_all <- ggplot(all_df, aes(x = x, y = y, color = month)) +
        geom_point(alpha = 0.6, size = 0.9) +
        facet_wrap(~ combo, scales = scales, nrow = nrow) +
        labs(title = paste(site, paste0(yname, " vs ", xname)),
             x = paste(xname, " (", xunits, ")"),
             y = paste(yname, " (", yunits, ")"),
             color = "Month") +
        theme(plot.title = element_text(hjust = 0.5))

    if (log_x) {
        p_all <- p_all + scale_x_log10()
    }

    if (!is.null(xlim)) {
        p_all <- p_all + xlim(xlim)
    }

    if (!is.null(ylim)) {
        p_all <- p_all + ylim(ylim)
    }

    return(p_all)
}

plot_ratio <- function(x, y, xname, yname, xunits, yunits,
                       ignored_layers = NULL, nrow = 2, scales = "fixed") {
    # Read raw data
    xdata <- read_data(x)
    ydata <- read_data(y)

    # Identify observed and predicted layer names for each variable
    std_ignore <- c("Year", "Day", "Site")
    pred_x_layers <- src@name
    obs_x_layers <- setdiff(names(xdata),
                            intersect(names(xdata), c(std_ignore, pred_x_layers)))

    pred_y_layers <- src@name
    obs_y_layers <- setdiff(names(ydata),
                            intersect(names(ydata), c(std_ignore, pred_y_layers)))

    # Optionally ignore specific observed layers
    if (!is.null(ignored_layers)) {
        obs_x_layers <- setdiff(obs_x_layers, intersect(ignored_layers, obs_x_layers))
        obs_y_layers <- setdiff(obs_y_layers, intersect(ignored_layers, obs_y_layers))
    }

    # Long format for x and y
    x_long <- tidyr::pivot_longer(xdata, cols = c(obs_x_layers, pred_x_layers),
                                  names_to = "source_x", values_to = "x")
    y_long <- tidyr::pivot_longer(ydata, cols = c(obs_y_layers, pred_y_layers),
                                  names_to = "source_y", values_to = "y")

    # Merge by common keys
    by <- intersect(c("Year", "Day", "Site"), intersect(names(x_long), names(y_long)))
    data <- merge(x_long, y_long, by = by)

    # Enrich with date/month for coloring
    data$date <- calc_date(data$Year, data$Day)
    data$month <- factor(as.integer(format(data$date, "%m")), levels = 1:12, labels = month.abb)

    # Predicted ratio (unique per date)
    pred_df <- dplyr::filter(data, source_x == pred_x_layers, source_y == pred_y_layers)
    pred_df <- dplyr::mutate(pred_df, predicted_ratio = y / x)
    pred_df <- pred_df[is.finite(pred_df$predicted_ratio), c("Year", "Day", "predicted_ratio", "month")]
    pred_df <- unique(pred_df)

    # Observed ratio for all combinations of observed sources
    obs_df <- dplyr::filter(data, source_x %in% obs_x_layers, source_y %in% obs_y_layers)
    if (nrow(obs_df) == 0) {
        # Fallback: return a simple time-series of predicted ratio if no observations exist
        ts_df <- dplyr::mutate(pred_df, combo = paste0("Predicted ", yname, "/", xname))
        p <- ggplot(ts_df, aes(x = Year + (Day - 1) / 365, y = predicted_ratio, color = month)) +
            geom_point(alpha = 0.6, size = 0.9) +
            labs(
                title = paste(site, paste0(yname, " / ", xname, " Ratios (No observations)")),
                x = "Year",
                y = paste0("Predicted ", yname, "/", xname, " (", yunits, "/", xunits, ")"),
                color = "Month"
            ) +
            theme(plot.title = element_text(hjust = 0.5))
        return(p)
    }

    obs_df <- dplyr::mutate(obs_df, observed_ratio = y / x)
    obs_df <- obs_df[is.finite(obs_df$observed_ratio), ]

    # Join observed ratios with predicted ratios by date
    plot_df <- dplyr::inner_join(obs_df, pred_df, by = c("Year", "Day", "month"))

    # Facet label per observed combination
    plot_df <- dplyr::mutate(
        plot_df,
        combo = paste0(source_y, " vs ", source_x)
    )

    # Scatter: observed ratio (x) vs predicted ratio (y)
    p <- ggplot(plot_df, aes(x = observed_ratio, y = predicted_ratio, color = month)) +
        geom_point(alpha = 0.6, size = 0.9) +
        geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey40") +
        facet_wrap(~ combo, scales = scales, nrow = nrow) +
        labs(
            title = paste(site, paste0(yname, "/", xname, ": Predicted vs Observed")),
            x = paste0("Observed ", yname, "/", xname, " (", yunits, "/", xunits, ")"),
            y = paste0("Predicted ", yname, "/", xname, " (", yunits, "/", xunits, ")"),
            color = "Month"
        ) +
        theme(plot.title = element_text(hjust = 0.5))

    return(p)
}
```

## Overview {.tabset}

```{r, results="asis"}
cat(params$description, "\n")
```

### LAI

```{r benchmark_lai}
ozflux_panel(src, "dave_lai", site, show_all_observations = FALSE)
```

### GPP

```{r benchmark_gpp}
ozflux_panel(src, "dave_gpp", site, show_all_observations = FALSE)
```

### NEE

```{r benchmark_nee}
ozflux_panel(src, "dave_nee", site)
```

### Respiration

```{r benchmark_resp}
ozflux_panel(src, "dave_resp", site)
```

### ET

```{r benchmark_transpiration}
ozflux_panel(src, "dave_aet", site)
```

### Above-Ground Biomass

```{r benchmark_biomass}
ozflux_panel(src, "dave_aboveground_tree_biomass", site)
```

### Height

```{r benchmark_height}
ozflux_panel(src, "dave_height", site)
```

### Diameter

```{r benchmark_diameter}
ozflux_panel(src, "dave_diameter", site)
```

### Soil Moisture

```{r benchmark_soil_moisture}
# Register an observation reader for EucFACE soil moisture.
if (site == "CumberlandPlain") {
    eucface_path <- "~/code/lpj-guess/scripts/ozflux-lpjg/data/eucface"
    filename <- "EucFACE_soil_moisture_1m_sitecol.csv"
    eucface_file <- file.path(eucface_path, filename)
    eucface_reader <- create_csv_reader("EucFACE_soil_moisture_1m",
                                        "EucFACE_soil_moisture_1m",
                                        eucface_file,
                                        "swmm_100",
                                        layers = list("swmm_100" = "swc.sum"),
                                        site_col = "site",
                                        lat_col = NULL,
                                        lon_col = NULL,
                                        time_col = "Date",
                                        time_fmt = "%Y-%m-%d",
                                        infer_site = TRUE)
    register_reader(eucface_reader)
    var <- "dave_swmm_100"
} else {
    var <- "dave_swavail_100"
}
ozflux_panel(src, var, site, show_all_observations = FALSE)
```

## Carbon Budget {.tabset}

### Annual Carbon Fluxes

```{r carbon_fluxes_annual}
# Read daily fluxes. These are used later for the daily flux plots, and we sum
# the observations so that we have some observations for the annual plots.

# TODO: break down respiration into growth/maintenance/etc
nee_data <- read_data("dave_nee")
npp_data <- read_data("dave_npp")
gpp_data <- read_data("dave_gpp")
resp_data <- read_data("dave_resp")

nee_data <- rename(nee_data, nee = all_of(src@name), observed_nee = flux_nee)
# We don't have NPP observations, so npp_data comes out with the right colname.
gpp_data <- rename(gpp_data, gpp = all_of(src@name), observed_gpp = flux_gpp)
resp_data <- rename(resp_data, resp = all_of(src@name),
                    observed_resp = flux_resp)

# For each year in data, compute total observed flux, for fluxes which have
# daily observations (ie NEE, GPP, Resp).
obs_nee <- nee_data %>%
    dplyr::group_by(Year) %>%
    dplyr::summarise(observed_nee = sum(observed_nee, na.rm = TRUE) / 1000)
obs_gpp <- gpp_data %>%
    dplyr::group_by(Year) %>%
    dplyr::summarise(observed_gpp = sum(observed_gpp, na.rm = TRUE) / 1000)
obs_resp <- resp_data %>%
    dplyr::group_by(Year) %>%
    dplyr::summarise(observed_resp = sum(observed_resp, na.rm = TRUE) / 1000)
obs_data <- merge(obs_nee, obs_gpp, by = "Year")
obs_data <- merge(obs_data, obs_resp, by = "Year")

# GPP, NPP, NEE, Respiration
acflux_vars <- c("dave_anee", "dave_anpp", "dave_agpp", "dave_aresp")
data <- read_data(acflux_vars)
acflux_data <- data
names(data) <- gsub(paste0(src@name, "_a"), "", names(data))

data <- merge(data, obs_data, by = "Year")

# Plot annual fluxes.
fluxes <- gsub("dave_a", "", acflux_vars)
cols <- c(fluxes, paste0("observed_", fluxes))
cols <- intersect(cols, names(data))
data_long <- pivot_longer(data, cols = cols, names_to = "layer",
                          values_to = "value") %>%
    mutate(source = ifelse(grepl("observed", layer), "observed", "predicted"),
           flux = gsub("observed_", "", layer)) %>%
    mutate(flux = factor(flux, levels = c("gpp", "npp", "nee", "resp")))

labeller <- c(nee = "NEE", npp = "NPP", gpp = "GPP", resp = "Resp")

ggplot(data_long) +
    geom_line(data = dplyr::filter(data_long),
              aes(x = Year, y = value, color = source)) +
    facet_wrap(~ flux, scales = "free_y", labeller = as_labeller(labeller)) +
    ylab("Carbon Flux (kgC/m2/year)") +
    labs(title = paste(site, "Carbon Fluxes"), color = "Type") +
    scale_color_manual(
        values = daveanalysis:::get_colour_palette(2),
        breaks = c("observed", "predicted"),
        labels = c("Observed", "Predicted")
    ) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Daily Carbon Fluxes

```{r carbon_fluxes_daily}
data <- merge(nee_data, npp_data, by = c("Year", "Day"))
data <- merge(data, gpp_data, by = c("Year", "Day"))
data <- merge(data, resp_data, by = c("Year", "Day"))
data$date <- calc_date(data$Year, data$Day)

vars <- c("nee", "npp", "gpp", "resp")

predicted_cols <- intersect(vars, names(data))
observed_cols <- intersect(paste0("observed_", vars), names(data))

# Pivot predicted values
pred_long <- pivot_longer(
    data,
    cols = all_of(predicted_cols),
    names_to = "flux",
    values_to = "value"
) %>% mutate(source = "predicted")

# Pivot observed values (only for those that exist)
obs_long <- pivot_longer(
    data,
    cols = all_of(observed_cols),
    names_to = "col",
    values_to = "value"
) %>%
    mutate(
        flux = sub("^observed_", "", col),
        source = "observed"
    ) %>%
    select(-col)

# Combine
data_long <- bind_rows(pred_long, obs_long) %>%
    mutate(
        flux = factor(flux, levels = c("gpp", "npp", "nee", "resp")),
        source = factor(source, levels = c("predicted", "observed"))
    )

labeller <- c(nee = "NEE", npp = "NPP", gpp = "GPP", resp = "Resp")
# Faceted plot: one panel per flux, lines for observed vs predicted
ggplot(data_long) +
    geom_line(
        data = dplyr::filter(data_long, source == "observed"),
        aes(x = date, y = value, color = source)
    ) +
    geom_line(
        data = dplyr::filter(data_long, source == "predicted"),
        aes(x = date, y = value, color = source)
    ) +
    facet_wrap(
        ~ flux,
        scales = "free_y",
        ncol = 2,
        labeller = as_labeller(labeller)
    ) +
    xlab("Date") +
    ylab("Carbon Flux (gC/m2/day)") +
    labs(title = paste(site, "Daily Carbon Fluxes"), color = "Type") +
    scale_color_manual(
        values = daveanalysis:::get_colour_palette(2),
        breaks = c("observed", "predicted"),
        labels = c("Observed", "Predicted")
    ) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Annual Carbon Pools

```{r carbon_pools_annual}
cpool_layers <- c("VegC", "StandingC", "LitterC", "SoilC", "total")
data <- read_data("dave_acpool", layers = cpool_layers)
data_long <- pivot_longer(data, cols = cpool_layers, names_to = "layer",
                          values_to = "value") %>%
    mutate(layer = factor(layer, levels = cpool_layers))
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    ylab("C Mass (kgC/m2)") +
    labs(title = paste(site, "Carbon Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Carbon Pools

```{r carbon_pools_daily}
cpool_layers <- c("VegC", "StandingC", "LitterC", "SoilC", "total")
data <- read_data("dave_cpool", layers = cpool_layers)
data$date <- calc_date(data$Year, data$Day)
data_long <- pivot_longer(data, cols = cpool_layers, names_to = "layer",
                          values_to = "value") %>%
    mutate(layer = factor(layer, levels = cpool_layers))

ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    xlab("Date") +
    ylab("C Mass (kgC/m2)") +
    labs(title = paste(site, "Carbon Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Carbon in Litter

```{r clitter}
layers <- c("SURFMETA", "SURFSTRUCT", "SURFCWD", "SURFFWD")
data <- read_data("dave_clitter", layers = layers)
data$date <- calc_date(data$Year, data$Day)
data_long <- pivot_longer(data, cols = layers, names_to = "layer",
                          values_to = "value") %>%
    mutate(layer = factor(layer, levels = layers))
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    xlab("Date") +
    ylab("C Mass (kgC/m2)") +
    labs(title = paste(site, "Litter C Mass")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Standing Dead Biomass

```{r standing_dead_biomass}
pools <- c("leaf", "root", "sap", "heart", "repr")
data <- NULL
for (pool in pools) {
    var <- paste0("dave_cmass_standing_dead_", pool)
    pool_data <- read_data(var, layers = pft)
    pool_data <- rename(pool_data, !!pool := all_of(pft))
    if (is.null(data)) {
        data <- pool_data
    } else {
        data <- merge(data, pool_data, by = c("Year", "Day"))
    }
}

data$date <- calc_date(data$Year, data$Day)
data_long <- pivot_longer(data, cols = pools, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    xlab("Date") +
    ylab("C Mass (kgC/m2)") +
    labs(title = paste(site, "Standing Dead Biomass")) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Respiration

```{r respiration}
vars <- c("maintenance", "growth")
data <- read_data(paste0("dave_resp_", vars))
data$date <- calc_date(data$Year, data$Day)
names(data) <- gsub(paste0(src@name, "_resp_"), "", names(data))
data_long <- pivot_longer(data, cols = vars, names_to = "respiration",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = respiration)) +
    xlab("Date") +
    ylab("Respiration (gC/m2/day)") +
    labs(title = paste(site, "Respiration")) +
    scale_color_manual(values = daveanalysis:::get_colour_palette(2)) +
    theme(plot.title = element_text(hjust = 0.5))
resp_data <- data
```

### Combined Carbon Fluxes


```{r combined_fluxes}
gpp_data <- read_data("dave_gpp", read_obs = FALSE)
data <- merge(resp_data, gpp_data, by = c("Year", "Day"))
data$date <- calc_date(data$Year, data$Day)

data_long <- pivot_longer(data, cols = c("maintenance", "growth", "gpp"),
                          names_to = "flux", values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = flux)) +
    xlab("Date") +
    ylab("Flux (gC/m2/day)") +
    labs(title = paste(site, "Combined Carbon Fluxes")) +
    scale_color_manual(values = daveanalysis:::get_colour_palette(3)) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Maintenance Respiration

```{r resp_maintenance}
pools <- c("leaf", "root", "sap")
outputs <- paste0("dave_resp_", pools)
data <- read_data(outputs)
data$date <- calc_date(data$Year, data$Day)
names(data) <- gsub(paste0(src@name, "_resp_"), "", names(data))
data_long <- pivot_longer(data, cols = pools, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    xlab("Date") +
    ylab("Respiration (gC/m2/day)") +
    labs(title = paste(site, "Maintenance Respiration")) +
    scale_color_manual(values = daveanalysis:::get_colour_palette(3)) +
    theme(plot.title = element_text(hjust = 0.5))
```

### CUE

```{r cue}
ozflux_plot(src, "dave_cue", site) +
    ylab("CUE (unitless)") +
    labs(title = paste(site, "Carbon Use Efficiency"))
```

## Nitrogen Budget {.tabset}

![](nitrogen-cycle.png)

### Sanity Check 0

This is a plot of this year's available N on the x-axis, against last year's
available N + this year's fluxes. If we have accounted for all of the fluxes
correctly, this should be a 1:1 line.

```{r anflux_sanity_check}
anflux_layers <- c("deposition", "fixation", "uptake", "gross_mineralisation",
                   "immobilisation", "net_mineralisation", "min_leach",
                   "org_leach", "volatilisation", "gas_emissions", "flux",
                   "flux_avail", "avail", "totaln")
data <- read_data("dave_nitrogen_budget_annual", layers = anflux_layers)

nflux_layers <- c("MANUREN", "NFERT", "ESTN", "HARVESTN", "SEEDN", "NH3_FIRE",
                  "NOx_FIRE", "N2O_FIRE", "N2_FIRE", "NH3_SOIL", "NO_SOIL",
                  "N2O_SOIL", "N2_SOIL", "NET_NITRIF", "NET_DENITRIF",
                  "GROSS_NITRIF", "GROSS_DENITRIF")
nflux <- read_data("dave_anflux", layers = nflux_layers)

data[, navail_prev := data.table::shift(avail, 1)]
data[, navail_expected := navail_prev + flux_avail]

data[, ntot_prev := data.table::shift(totaln, 1)]
data[, ntot_expected := ntot_prev + flux]

r2_avail <- with(data[-1, ], cor(avail, navail_expected)^2)
r2_total <- with(data[-1, ], cor(totaln, ntot_expected)^2)

# Plot navail and navail_expected from row 2 to the end.
ggplot(data[-1, ]) +
    geom_point(aes(x = avail, y = navail_expected)) +
    geom_point(aes(x = totaln, y = ntot_expected), color = "red") +
    labs(title = paste(site, "Expected vs Actual Available N")) +
    xlab("Actual (kgN/m2)") + ylab("Expected (kgN/m2)") +
    geom_text(
        x = -Inf, y = Inf,
        label = paste0("r2_avail = ", round(r2_avail, 2), "\nr2_total = ",
                       round(r2_total, 2)),
        hjust = -0.1, vjust = 1.25, size = 5
    )
anflux_data <- data
```

### Sanity Check 1

This is a plot of today's available N on the x-axis, against yesterday's
available N + today's fluxes. If we have accounted for all of the fluxes
correctly, this should be a 1:1 line.

```{r dnflux_sanity_check}
# Same order as anflux cols for comparison purposes
nbudget_cols <- c("deposition", "fixation", "uptake", "net_mineralisation",
                  "gross_mineralisation", "immobilisation", "min_leach",
                  "org_leach", "volatilisation", "gas_emissions", "flux_avail",
                  "flux", "avail", "totaln")
data <- read_data("dave_nitrogen_budget_daily", layers = nbudget_cols)
data$date <- calc_date(data$Year, data$Day)

data[, navail_prev := data.table::shift(avail, 1)]
data[, navail_expected := navail_prev + flux_avail]

data[, ntot_prev := data.table::shift(totaln, 1)]
data[, ntot_expected := ntot_prev + flux]

r2_avail <- with(data[-1, ], cor(avail, navail_expected)^2)
r2_total <- with(data[-1, ], cor(totaln, ntot_expected)^2)

# Plot navail and navail_expected from row 2 to the end.
ggplot(data[-1, ], aes(x = avail, y = navail_expected)) +
    geom_point() + labs(title = paste(site, "Expected vs Actual Available N")) +
    xlab("Actual (kgN/m2)") + ylab("Expected (kgN/m2)") +
    geom_text(
        x = -Inf, y = Inf,
        label = paste0("r2_avail = ", round(r2_avail, 2), "\nr2_total = ",
                       round(r2_total, 2)),
        hjust = -0.1, vjust = 1.25, size = 5
    )
dnflux_data <- data
```

### Daily Nitrogen Pools

```{r npool_daily}
npool_cols <- c("VegN", "StandingN", "LitterN", "SoilN", "AvailN")
data <- read_data("dave_dnpool", layers = npool_cols)
data$date <- calc_date(data$Year, data$Day)

# Convert all layers from kgN to gN by multiplying by 1000.
for (col in npool_cols) {
    data[, (col) := (get(col)) * 1000]
}

df_long <- pivot_longer(data, cols = npool_cols, names_to = "layer",
                        values_to = "value")
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    ylab("Nitrogen Pool (gN/m2)") +
    labs(title = paste(site, "Nitrogen Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Nitrogen in Litter

```{r nlitter}
layers <- c("SURFMETA", "SURFSTRUCT", "SURFCWD", "SURFFWD")
data <- read_data("dave_nlitter", layers = layers)
data$date <- calc_date(data$Year, data$Day)
data_long <- pivot_longer(data, cols = layers, names_to = "layer",
                          values_to = "value") %>%
    dplyr::mutate(layer = factor(layer, levels = layers))
# Convert kgN/m2 to gN/m2
data_long$value <- data_long$value * 1000
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    xlab("Date") +
    ylab("Litter N (gN/m2)") +
    labs(title = paste(site, "Nitrogen in Litter")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Annual Nitrogen Fluxes

```{r anflux_avail}
df_long <- pivot_longer(anflux_data, cols = anflux_layers, names_to = "layer",
                        values_to = "value")

# Convert all layers from kgN to gN by multiplying by 1000.
df_long$value <- df_long$value * 1000
ggplot(df_long) +
    geom_line(aes(x = Year, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    ylab("Nitrogen Flux (gN/m2/year)") +
    labs(title = paste(site, "Annual Nitrogen Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
rm(anflux_data)
```

### Daily Nitrogen Fluxes

```{r nflux_daily}
data <- dnflux_data

# Plot fluxes
df_long <- pivot_longer(data, cols = anflux_layers, names_to = "layer",
                        values_to = "value") %>%
    dplyr::mutate(layer = factor(layer, levels = sort(anflux_layers)))

# Convert all layers from kgN to gN by multiplying by 1000.
df_long$value <- df_long$value * 1000

ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    ylab("Nitrogen Flux (gN/m2/day)") +
    labs(title = paste(site, "Nitrogen Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
rm(dnflux_data)
```

## Water Budget {.tabset}

### Layerwise Soil Moisture

```{r soil_moisture}
sw_layers <- paste0("sw_", 0:14)
data <- read_data("dave_sw", layers = sw_layers)
data$date <- calc_date(data$Year, data$Day)
df_long <- pivot_longer(data, cols = sw_layers, names_to = "layer",
                        values_to = "value")
df_long$layer_num <- as.integer(sub("^sw_", "", df_long$layer))
df_long$layer <- factor(df_long$layer,
                        levels = paste0("sw_", sort(unique(df_long$layer_num))))
labeller <- function(s) paste("layer", as.integer(sub("^sw_", "", s)))
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer,
               labeller = as_labeller(labeller)) +
    ylab("Soil Moisture (0=Wilting Point, 1=Field Capacity)") +
    labs(title = paste(site, "Soil Moisture")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
sw_data <- data
```

### Distribution of Soil Moisture

```{r soil_moisture_dist}
# Use sw_data from previous chunk to show per-layer distributions
sw_layers <- paste0("sw_", 0:14)

# Long format with numeric ordering for facets
sw_long <- pivot_longer(
    sw_data,
    cols = all_of(sw_layers),
    names_to = "layer",
    values_to = "value"
)
sw_long$layer_num <- as.integer(sub("^sw_", "", sw_long$layer))
sw_long$layer <- factor(
    sw_long$layer,
    levels = paste0("sw_", sort(unique(sw_long$layer_num)))
)
labeller <- function(s) paste("layer", as.integer(sub("^sw_", "", s)))

# Faceted histograms per layer (values are already 0–1)
ggplot(sw_long) +
    geom_histogram(aes(x = value, fill = layer), bins = 30, color = "white") +
    facet_wrap(~ layer, labeller = as_labeller(labeller), ncol = 5) +
    xlab("Soil Moisture (0–1)") +
    ylab("Count") +
    xlim(0, 1) +
    scale_x_continuous(
        breaks = seq(0, 1, by = 0.5)
    ) +
    labs(title = paste(site, "Distribution of Soil Moisture by Layer")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Layerwise Soil Water Potential

```{r soil_water_potential}
layers <- paste0("psi_", 0:14)
data <- read_data("dave_soil_psi_layer", layers = layers)
data$date <- calc_date(data$Year, data$Day)
df_long <- pivot_longer(data, cols = layers, names_to = "layer",
                        values_to = "value")
df_long$layer_num <- as.integer(sub("^psi_", "", df_long$layer))
df_long$layer <- factor(df_long$layer,
                        levels = paste0("psi_", sort(unique(df_long$layer_num))))
labeller <- function(s) paste("layer", as.integer(sub("^psi_", "", s)))
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer,
               labeller = as_labeller(labeller)) +
    ylab("Soil Water Potential (MPa)") +
    labs(title = paste(site, "Soil Water Potential")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
psi_data <- data
```

### Distribution of Soil Water Potential

```{r soil_water_potential_dist}
# Use psi_data from previous chunk to show per-layer distributions
psi_layers <- paste0("psi_", 0:14)

# Long format with numeric ordering for facets
psi_long <- pivot_longer(
    psi_data,
    cols = all_of(psi_layers),
    names_to = "layer",
    values_to = "value"
)
psi_long$layer_num <- as.integer(sub("^psi_", "", psi_long$layer))
psi_long$layer <- factor(
    psi_long$layer,
    levels = paste0("psi_", sort(unique(psi_long$layer_num)))
)
psi_labeller <- function(s) paste("layer", as.integer(sub("^psi_", "", s)))

# Faceted histograms per layer
ggplot(psi_long) +
    geom_histogram(aes(x = value, fill = layer), bins = 30, color = "white") +
    facet_wrap(~ layer, labeller = as_labeller(psi_labeller), ncol = 5) +
    xlab("Soil Water Potential (MPa)") +
    ylab("Count") +
    labs(title = paste(site, "Distribution of Soil Water Potential by Layer")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Layerwise SWC vs SWP

```{r layerwise_swc_vs_swp}
# sw_data and psi_data read in above chunks
layers <- 0:14
sw_layers <- paste0("sw_", layers)
psi_layers <- paste0("psi_", layers)

names(psi_data) <- gsub("psi_", "psi_", names(psi_data))

# Long form with a common integer 'layer' index
sw_long <- pivot_longer(sw_data, cols = all_of(sw_layers), names_to = "layer",
                        values_to = "swc") %>%
    mutate(layer = as.integer(sub("^sw_", "", layer)))

psi_long <- pivot_longer(psi_data, cols = all_of(paste0("psi_", layers)),
                         names_to = "layer", values_to = "psi") %>%
    mutate(layer = as.integer(sub("^psi_", "", layer)))

# Join by Year/Day/layer
plot_df <- dplyr::inner_join(sw_long, psi_long, by = c("Year", "Day", "layer"))

layer_names <- paste0("layer ", sort(unique(plot_df$layer)))
plot_df$layer_f <- factor(paste0("layer ", plot_df$layer), levels = layer_names)

# Scatter: SWC (x) vs SWP (y), faceted by layer
ggplot(plot_df, aes(x = swc, y = psi)) +
    geom_point(alpha = 0.4, size = 0.8, color = "#0072B2") +
    facet_wrap(~ layer_f) +
    xlab("Soil Moisture (0–1)") +
    ylab("Soil Water Potential (MPa)") +
    labs(title = paste(site, "Water Potential vs Water Content")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Weighted Soil Water Potential

```{r weighted_soil_water_potential}
ozflux_plot_layerwise(src, "dave_weighted_psi", site, layers = pft) +
    ylab("Weighted Soil Water Potential (MPa)") +
    labs(title = paste(site, "Weighted Soil Water Potential")) +
    theme(legend.position = "none")
```

### Annual Water Fluxes

```{r awflux}
wflux_layers <- c("precip", "evap", "transp", "interception", "surfrunoff",
                  "drainrunoff", "baserunoff", "flux")
data <- read_data("dave_water_budget_annual", layers = wflux_layers)
data_long <- pivot_longer(data, cols = wflux_layers, names_to = "layer",
                          values_to = "value")
data_long$layer <- factor(data_long$layer, levels = wflux_layers)
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    ylab("Water Flux (mm/year)") +
    labs(title = paste(site, "Water Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Water Fluxes

```{r water_fluxes}
data <- read_data("dave_water_budget_daily", layers = wflux_layers)
data$date <- calc_date(data$Year, data$Day)
df_long <- pivot_longer(data, cols = wflux_layers, names_to = "layer",
                        values_to = "value")
df_long$layer <- factor(df_long$layer, levels = wflux_layers)
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    ylab("Water Flux (mm/day)") +
    labs(title = paste(site, "Water Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Water Stress

```{r water_stress_breakdown}
# sw_data read in a previous chunk
sw_layers <- paste0("sw_", 0:14)
# sw_data <- read_data("dave_sw", layers = sw_layers)

wscal <- read_data("dave_wscal", layers = pft)
wcont <- sw_data

wscal <- rename(wscal, wscal = all_of(pft))

data <- merge(wscal, wcont, by = c("Year", "Day"))
data$date <- calc_date(data$Year, data$Day)

data$sw_mean <- rowMeans(data[, ..sw_layers], na.rm = TRUE)
data$sw_min  <- do.call(pmin, c(as.list(data[, ..sw_layers]),
                                list(na.rm = TRUE)))
data$sw_max  <- do.call(pmax, c(as.list(data[, ..sw_layers]),
                                list(na.rm = TRUE)))

lines_long <- pivot_longer(
    data,
    cols = c("wscal", "sw_mean"),
    names_to = "series",
    values_to = "value"
)

ggplot(data, aes(x = date)) +
    geom_ribbon(aes(ymin = sw_min, ymax = sw_max), fill = "#56B1F7",
                alpha = 0.25) +
    geom_line(data = lines_long, aes(y = value, color = series),
              linewidth = 0.6) +
    scale_color_manual(
        values = c(wscal = "#D55E00", sw_mean = "#0072B2"),
        labels = c(wscal = "Water stress (wscal)",
                   sw_mean = "Mean soil moisture")
    ) +
    xlab("Date") +
    ylab("Water Stress/Content (0–1)") +
    labs(
        title = paste(site, "Water stress vs soil moisture"),
        color = ""
    ) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "top")
```

### Water Stress vs. Soil Moisture

```{r water_stress_vs_soil_moisture}
# Using data from previous chunk.
ggplot(data, aes(x = sw_mean, y = wscal)) +
    geom_point(color = "#0072B2") +
    xlab("Non-weighted Mean Soil Moisture (0-1)") +
    ylab("Water Stress (0-1)") +
    xlim(0, 1) +
    labs(title = paste(site, "Water stress vs soil moisture")) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Water Stress vs. Weighted Soil Water Potential

```{r water_stress_vs_weighted_soil_water_potential}
weighted_psi <- read_data("dave_weighted_psi", layers = pft)
weighted_psi <- rename(weighted_psi, "weighted_psi" = pft)

data <- merge(data, weighted_psi, by = c("Year", "Day"))
ggplot(data, aes(x = weighted_psi, y = wscal)) +
    geom_point(color = "#0072B2") +
    xlab("Weighted Soil Water Potential (MPa)") +
    ylab("Water Stress (0-1)") +
    labs(title = paste(site, "Water stress vs weighted soil water potential")) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Water Stress vs. Mean Soil Water Potential

```{r water_stress_vs_soil_water_potential}
psi_layers <- paste0("psi_", 0:14)
psi_data$psi_mean <- rowMeans(psi_data[, ..psi_layers], na.rm = TRUE)

data <- merge(data, psi_data[, c("Year", "Day", "psi_mean")],
              by = c("Year", "Day"))
title <- paste(site, "Water stress vs unweighted mean soil water potential")
ggplot(data, aes(x = psi_mean, y = wscal)) +
    geom_point(color = "#0072B2") +
    xlab("Weighted Soil Water Potential (MPa)") +
    ylab("Water Stress (0-1)") +
    labs(title = title) +
    theme(plot.title = element_text(hjust = 0.5))
```

## SOM Pools {.tabset}

### Daily SOM Carbon

```{r sompool_c}
# Note: we could plot annual SOM pools, but there's not much point. They don't
# really tell us anything that the daily plots don't, and they certainly
# obfuscate the seasonal patterns.
plot_sompool("dave_sompool_cmass", "Carbon Mass (gC/m2)", "SOM Carbon Mass")
```

### Daily SOM Nitrogen

```{r dsompool_n}
plot_sompool("dave_sompool_nmass", "Nitrogen Mass (gN/m2)",
             "SOM Nitrogen Mass")
```

### SOM Stoichiometry

```{r sompool_stoich}
cmass <- read_data("dave_sompool_cmass", layers = som_pools)
nmass <- read_data("dave_sompool_nmass", layers = som_pools)

data <- merge(cmass, nmass, by = c("Year", "Day"),
              suffixes = c("_cmass", "_nmass"))
data$date <- calc_date(data$Year, data$Day)

# Calculate cmass/nmass for each pool.
for (pool in som_pools) {
    cmass_col <- paste0(pool, "_cmass")
    nmass_col <- paste0(pool, "_nmass")
    data[[pool]] <- data[[cmass_col]] / data[[nmass_col]]
    data[[cmass_col]] <- NULL
    data[[nmass_col]] <- NULL
}

cton_min_slowsom <- 15
cton_max_slowsom <- 30
cton_min_soilmicro <- 6
cton_max_soilmicro <- 15
cton_min_surfhumus <- 15
cton_max_surfhumus <- 30
cton_min_surfmicro <- 10
cton_max_surfmicro <- 20

data_long <- pivot_longer(data, cols = som_pools, names_to = "pool",
                          values_to = "cton")
data_long$pool <- factor(data_long$pool, levels = sort(som_pools))

thresholds <- tribble(
    ~pool,         ~value,
    "SLOWSOM",     cton_min_slowsom,
    "SLOWSOM",     cton_max_slowsom,
    "SOILMICRO",   cton_min_soilmicro,
    "SOILMICRO",   cton_max_soilmicro,
    "SURFHUMUS",   cton_min_surfhumus,
    "SURFHUMUS",   cton_max_surfhumus,
    "SURFMICRO",   cton_min_surfmicro,
    "SURFMICRO",   cton_max_surfmicro
) %>% mutate(pool = factor(pool, levels = levels(data_long$pool)))

ggplot(data_long) +
    geom_line(aes(x = date, y = cton, color = pool)) +
    geom_hline(data = thresholds, aes(yintercept = value), linetype = "dotted",
               color = "black") +
    facet_wrap(~ pool, scales = "free_y") +
    ylab("C:N ratio") +
    labs(title = paste(site, "SOM Pool C:N Ratios")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### SOM Immobilisation

```{r sompool_nimmob}
plot_sompool("dave_sompool_nimmob", "Immobilisation (gN/m2)",
             "SOM Nitrogen Immobilisation")
```

### SOM Gross Mineralisation

```{r sompool_nmin_gross}
plot_sompool("dave_sompool_nmin_gross", "Mineralisation (gN/m2)",
             "Gross Nitrogen Mineralisation")
```

### SOM Net Mineralisation

```{r sompool_nmin_net}
# Net mineralisation = gross mineralisation - immobilisation
nmin_gross <- read_data("dave_sompool_nmin_gross", layers = som_pools)
nmin_immob <- read_data("dave_sompool_nimmob", layers = som_pools)
data <- merge(nmin_gross, nmin_immob, by = c("Year", "Day"),
              suffixes = c("_gross", "_immob"))
for (pool in som_pools) {
    gross_col <- paste0(pool, "_gross")
    immob_col <- paste0(pool, "_immob")
    # Convert to grams at the same time.
    data[[pool]] <- (data[[gross_col]] - data[[immob_col]]) * 1000
    data[[gross_col]] <- NULL
    data[[immob_col]] <- NULL
}
data$date <- calc_date(data$Year, data$Day)
data_long <- pivot_longer(data, cols = som_pools, names_to = "pool",
                          values_to = "value")
data_long$pool <- factor(data_long$pool, levels = sort(som_pools))
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    ylab("Net Mineralisation (gN/m2)") +
    labs(title = paste(site, "Net Mineralisation")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Normalised Net Mineralisation

```{r sompool_nmin_net_norm}
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool) +
    ylab("Net Mineralisation (gN/m2)") +
    labs(title = paste(site, "Net Mineralisation")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Decay Reduction

```{r sompool_decay_reduction}
plot_sompool("dave_sompool_decay_reduction", "Decay Reduction (0-1)",
             "SOM Decay Reduction")
```

## Allocation {.tabset}

### Stress

```{r stress}
ggarrange(
    ggarrange(
        ozflux_plot(src, "dave_wscal", site) +
            ylab("wscal (0=no stress, 1=max stress)") +
            theme(legend.position = "none"),
        ozflux_plot(src, "dave_nscal", site) +
            ylab("nscal (0=no stress, 1=max stress)") +
            theme(legend.position = "none"),
        ncol = 2
    ),
    ozflux_plot(src, "dave_ltor", site) +
        ylab("Leaf:Root Ratio") +
        theme(legend.position = "none"),
    nrow = 2
)
```

### Carbon Allocation

```{r calloc}
layers <- c("dave_cmass_leaf", "dave_cmass_leaf_limit",
            "dave_cmass_root", "dave_cmass_root_limit",
            "dave_cmass_sap", "dave_cmass_sap_limit",
            "dave_cmass_storage", "dave_cmass_storage_limit",
            "dave_alpha_leaf", "dave_alpha_root",
            "dave_alpha_sap", "dave_alpha_storage",
            "dave_cgrow_leaf", "dave_cgrow_root",
            "dave_cgrow_sap", "dave_cgrow_storage")

df <- read_data(layers, layers = pft)
df$date <- calc_date(df$Year, df$Day)
# Replace e.g. "dave_cmass_leaf" with "MRS_cmass_leaf"
names <- gsub("dave_", "", layers)
# Rename exactly "MRS" to MRS_cmass_leaf
names(df) <- gsub(paste0(src@name, "_"), "", names(df))

df_long <- pivot_longer(df, cols = names, names_to = "layer",
                        values_to = "value") %>%
    mutate(component = sub("_limit$", "", layer),
           type = ifelse(grepl("_limit$", layer), "limit", "biomass"))

ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = type)) +
    facet_wrap(~ component, scales = "free_y") +
    scale_color_manual(values = daveanalysis:::get_colour_palette(2),
                       labels = c("actual", "limit")) +
    theme(legend.position = "none")
```

### Annual Carbon Allocation

```{r acalloc}
pools <- c("leaf", "root", "sap", "storage")
alpha_layers <- paste0("dave_alpha_", pools)
cgrow_layers <- paste0("dave_cgrow_", pools)

alpha_data <- read_data(alpha_layers)
cgrow_data <- read_data(cgrow_layers)

names(alpha_data) <- gsub(paste0(src@name, "_"), "", names(alpha_data))
names(cgrow_data) <- gsub(paste0(src@name, "_"), "", names(cgrow_data))

# Aggregate to annual values. Alphas: mean, Cgrow: sum
alpha_data <- aggregate(alpha_data, by = list(alpha_data$Year), mean)
# Sums all non-grouping columns by Year; Year is not summed
cgrow_data <- aggregate(. ~ Year, data = cgrow_data, FUN = sum, na.rm = TRUE)

data <- merge(alpha_data, cgrow_data, by = "Year")

# Build a simple long-format data frame from your existing `data`
# Assumes data contains columns: Year, alpha_*, cgrow_*, for all pools.
alpha_name <- "Alpha (unitless)"
cgrow_name <- "Cgrow (kgC/m2)"
data_long <- data %>%
    pivot_longer(
        cols = matches("^(alpha_|cgrow_)"),
        names_to = "layer",
        values_to = "value"
    ) %>%
    mutate(
        quantity = if_else(str_starts(layer, "alpha_"),
                           alpha_name, cgrow_name),
        pool = str_remove(layer, "^(alpha_|cgrow_)"),
        pool = factor(pool, levels = pools),
        quantity = factor(quantity, levels = c(alpha_name, cgrow_name))
    )

ggplot(data_long, aes(x = Year, y = value, color = pool)) +
    geom_line() +
    facet_grid(quantity ~ ., scales = "free_y", switch = "y") +
    labs(x = "Year", y = NULL,
         title = paste(site, "Annual Carbon Allocation")) +
    theme(strip.placement = "outside",
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "bottom")
```

### Carbon Allocation Distribution

```{r calloc_dist}
# Boxplot distribution of annual alpha and cgrow by pool
# Assumes `data` contains columns Year, alpha_*, cgrow_* and `pools` exists

# Long format with pool and quantity
df_box <- data %>%
    pivot_longer(
        cols = matches("^(alpha_|cgrow_)"),
        names_to = "layer",
        values_to = "value"
    ) %>%
    mutate(
        quantity = if_else(str_starts(layer, "alpha_"), alpha_name, cgrow_name),
        pool = str_remove(layer, "^(alpha_|cgrow_)"),
        pool = factor(pool, levels = pools),
        quantity = factor(quantity, levels = c(alpha_name, cgrow_name))
    )

# Faceted panel: top = alpha, bottom = cgrow; one box per pool
ggplot(df_box, aes(x = pool, y = value, fill = pool)) +
    geom_boxplot(outlier.alpha = 0.5) +
    facet_grid(quantity ~ ., scales = "free_y", switch = "y") +
    labs(x = "Pool", y = NULL,
         title = paste(site, "Distribution of Annual Carbon Allocation")) +
    theme(strip.placement = "outside",
          strip.text.y.left = element_text(angle = 0),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

### Vegetation Carbon Pools

```{r cpool_veg}
layers <- c("leaf", "root", "sap", "storage", "repr")
outputs <- paste0("dave_cmass_", layers)
data <- read_data(outputs)
data$date <- calc_date(data$Year, data$Day)

# Rename e.g. MRS_cmass_leaf to leaf
names(data) <- gsub(paste0(src@name, "_cmass_"), "", names(data))

data_long <- pivot_longer(data, cols = layers, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    ylab("Carbon Mass (kgC/m2)") +
    labs(title = paste(site, "Vegetation Carbon Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Vegetation Nitrogen Pools

```{r npool_veg}
outputs <- paste0("dave_nmass_", layers)
data <- read_data(outputs)
data$date <- calc_date(data$Year, data$Day)

# Rename e.g. MRS_cmass_leaf to leaf
names(data) <- gsub(paste0(src@name, "_nmass_"), "", names(data))

data_long <- pivot_longer(data, cols = layers, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    ylab("Nitrogen Mass (kgN/m2)") +
    labs(title = paste(site, "Vegetation Nitrogen Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Carbon Turnover

```{r cturnover}
# cturnover outputs are in kgC/m2
pools <- c("leaf", "root", "sap")
outputs <- paste0("dave_cturnover_", pools)
data <- read_data(outputs)
data$date <- calc_date(data$Year, data$Day)

# Rename e.g. MRS_cturnover_leaf to leaf
names(data) <- gsub(paste0(src@name, "_cturnover_"), "", names(data))

data_long <- pivot_longer(data, cols = pools, names_to = "pool",
                          values_to = "value")
# Convert kg -> g
data_long$value <- data_long$value * 1000
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    ylab("Carbon Turnover (gC/m2)") +
    labs(title = paste(site, "Carbon Turnover")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Nitrogen Turnover

```{r nturnover}
# nturnover outputs are in gN/m2
pools <- c("leaf", "root", "sap")
outputs <- paste0("dave_nturnover_", pools)
data <- read_data(outputs)
data$date <- calc_date(data$Year, data$Day)

# Rename e.g. MRS_nturnover_leaf to leaf
names(data) <- gsub(paste0(src@name, "_nturnover_"), "", names(data))

data_long <- pivot_longer(data, cols = pools, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    ylab("Nitrogen Turnover (gN/m2)") +
    labs(title = paste(site, "Nitrogen Turnover")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Stoichiometry

```{r stoichiometry}
read_cton <- function(pool) {
    data <- read_cton_live(pool)
    data <- data[, c("Date", "cton_min", "cton", "cton_max")]
    names(data) <- c(
        "Date",
        paste0("cton_", pool, "_min"),
        paste0("cton_", pool),
        paste0("cton_", pool, "_max")
    )
    return(data)
}
cton_leaf <- read_cton("leaf")
cton_root <- read_cton("root")
cton_sap <- read_cton("sap")
cton <- merge(cton_leaf, cton_root, by = "Date")
cton <- merge(cton, cton_sap, by = "Date")
cton_long <- pivot_longer(
    cton,
    cols = starts_with("cton_"),
    names_to = c("metric", "pool", "bound"),
    names_pattern = "(cton)_(leaf|root|sap)(?:_(min|max))?",
    values_to = "value"
)
cton_long$pool <- factor(cton_long$pool, levels = c("leaf", "root", "sap"))
cton_actual <- dplyr::filter(cton_long, bound == "")
cton_bounds <- dplyr::filter(cton_long, bound != "")

ggplot() +
    geom_line(data = cton_actual, aes(x = Date, y = value, color = pool)) +
    geom_line(data = dplyr::filter(cton_bounds, bound == "min"),
              aes(x = Date, y = value), linetype = "dashed", color = "grey40") +
    geom_line(data = dplyr::filter(cton_bounds, bound == "max"),
              aes(x = Date, y = value), linetype = "dashed", color = "grey40") +
    facet_wrap(~ pool, scales = "free_y") +
    labs(title = paste(site, "Stoichiometry"), x = "Date", y = "C:N Ratio")
```

### Stoichiometry Normalised

```{r stoichiometry_normalised}
# Normalised position within [min, max] per pool
cton_norm <- with(cton, data.frame(
    Date = Date,
    leaf = (cton_leaf - cton_leaf_min) / (cton_leaf_max - cton_leaf_min),
    root = (cton_root - cton_root_min) / (cton_root_max - cton_root_min),
    sap  = (cton_sap  - cton_sap_min)  / (cton_sap_max  - cton_sap_min)
))

# Handle divisions by zero or invalid values
is_bad <- function(x) !is.finite(x)
cton_norm$leaf[is_bad(cton_norm$leaf)] <- NA_real_
cton_norm$root[is_bad(cton_norm$root)] <- NA_real_
cton_norm$sap[is_bad(cton_norm$sap)]   <- NA_real_

# Optionally clamp to [0,1]
cton_norm$leaf <- pmin(pmax(cton_norm$leaf, 0), 1)
cton_norm$root <- pmin(pmax(cton_norm$root, 0), 1)
cton_norm$sap  <- pmin(pmax(cton_norm$sap,  0), 1)

cton_norm_long <- pivot_longer(cton_norm, cols = c("leaf", "root", "sap"),
                               names_to = "pool", values_to = "norm")

ggplot(cton_norm_long) +
    geom_line(aes(x = Date, y = norm, color = pool)) +
    scale_y_continuous(limits = c(0, 1)) +
    labs(title = paste(site, "Normalised Stoichiometry Position"),
         x = "Date", y = "(cton - min) / (max - min)") +
    theme(plot.title = element_text(hjust = 0.5))
```

### Allometry

```{r allometry}
# fixme: eliminate whitespace
vars <- c("dave_height", "dave_diameter", "dave_basalarea", "dave_density")
data <- read_data(vars, read_obs = FALSE)
names(data) <- gsub(paste0(src@name, "_"), "", names(data))
data$date <- calc_date(data$Year, data$Day)
newnames <- gsub("dave_", "", vars)
data_long <- pivot_longer(data, cols = newnames, names_to = "variable",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = variable)) +
    facet_wrap(~ variable, scales = "free_y") +
    ylab("Value (m)") +
    labs(title = paste(site, "Allometry")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Mortality Fractions

```{r mortality_fractions}
mort_age <- read_data("dave_amort_age")
mort_greff <- read_data("dave_amort_greff")
cmass_mort <- read_data("dave_acmass_mort", layers = pft)

mort_age <- rename(mort_age, age = all_of(pft))
mort_greff <- rename(mort_greff, greff = all_of(pft))
cmass_mort <- rename(cmass_mort, cmass = all_of(pft))

data <- merge(mort_age, mort_greff, by = "Year")
data$mort_total <- data$age + data$greff
data <- merge(data, cmass_mort, by = "Year")

# Plot mortality fractions.
data_long <- pivot_longer(data, cols = c("age", "greff"),
                          names_to = "source", values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = source)) +
    ylab("Mortality Fraction") +
    labs(title = paste(site, "Mortality Fractions")) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Mortality C Mass

```{r mortality_cmass}
data$age_frac <- data$age / data$mort_total
data$greff_frac <- data$greff / data$mort_total

data$age_cmass <- data$age_frac * data$cmass
data$greff_cmass <- data$greff_frac * data$cmass

# Pivot to long format and name age_cmass as "age" and greff_cmass as "greff".
data_long <- pivot_longer(data, cols = c("age_cmass", "greff_cmass"),
                          names_to = "source", values_to = "value") %>%
    mutate(source = factor(source, levels = c("age_cmass", "greff_cmass"),
                           labels = c("age", "greff")))
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = source)) +
    ylab("Carbon Mass Mortality (kgC/m2)") +
    labs(title = paste(site, "Mortality C Mass")) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Diagnostics

```{r diagnostics}
vars <- c("dave_latosa", "dave_cue")
data <- read_data(vars, read_obs = FALSE)
names(data) <- gsub(paste0(src@name, "_"), "", names(data))
data$date <- calc_date(data$Year, data$Day)
newnames <- gsub("dave_", "", vars)
data_long <- pivot_longer(data, cols = newnames, names_to = "variable",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = variable)) +
    ylab(NULL) +
    labs(title = paste(site, "Diagnostics")) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Nitrogen Stress

```{r nitrogen_stress}
vars <- c("dave_ndemand", "dave_nmass_storage", "dave_nmass_storage_max",
          "dave_nretranslocated", "dave_fnuptake", "dave_nstorage_drawdown")
data <- read_data(vars, layers = pft)
names(data) <- gsub(paste0(src@name, "_"), "", names(data))
data$date <- calc_date(data$Year, data$Day)
data$nuptake <- data$fnuptake * data$ndemand

cols <- gsub("dave_", "", vars)
data_long <- pivot_longer(data, cols = cols, names_to = "variable",
                          values_to = "value")
# Convert kg -> g (except fnuptake)
data_long$value[data_long$variable != "fnuptake"] <-
    data_long$value[data_long$variable != "fnuptake"] * 1000
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = variable)) +
    facet_wrap(~ variable, scales = "free_y") +
    ylab("Nitrogen (gN/m2)") +
    labs(title = paste(site, "Nitrogen Stress Factors")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Nitrogen Usage

```{r annual_nitrogen_usage}
anstorage_drawdown <- read_data("dave_anstorage_drawdown", layers = pft)
anretranslocated <- read_data("dave_anretranslocated", layers = pft)
anuptake <- read_data("dave_anuptake", layers = pft)
nmass_storage <- read_data("dave_nmass_storage", layers = pft)
nmass_storage <- nmass_storage[Day == 365, ]
nmass_storage <- select(nmass_storage, -"Day")

vars <- c("anstorage_drawdown", "anretranslocated", "anuptake", "nmass_storage")
outputs <- paste0("dave_", vars)
data <- read_data(outputs, layers = pft, show_all_predictions = FALSE)
names(data) <- gsub(paste0(src@name, "_"), "", names(data))
data$delta_storage <- c(NA, diff(data$nmass_storage))

vars <- c(vars, "delta_storage")
data_long <- pivot_longer(data, cols = vars, names_to = "variable",
                          values_to = "value") %>%
    mutate(variable = factor(variable, levels = vars,
                             labels = c("Storage Drawdown", "Retranslocation",
                                        "Uptake", "Storage", "Delta Storage")))
# Convert kg to g
data_long$value <- data_long$value * 1e3
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = variable)) +
    ylab("Nitrogen (gN/m2)") +
    labs(title = paste(site, "Annual Nitrogen Usage")) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Number of Cohorts

```{r number_of_cohorts}
ozflux_plot(src, "dave_ancohort", site)
```

## Climate {.tabset}

### GPP vs Temperature

```{r gpp_vs_temperature}
plot_against("dave_met_temp", "dave_gpp",
             "Temperature", "GPP",
             "°C", "gC/m2/day", scales = "fixed")
```

### GPP vs PAR

```{r gpp_vs_par}
plot_against("dave_met_insol", "dave_gpp",
             "PAR", "GPP",
             "W/m2", "gC/m2/day", scales = "fixed")
```

### GPP vs ET

```{r gpp_vs_et}
plot_against("dave_aet", "dave_gpp",
             "ET", "GPP",
             "mm", "gC/m2/day", nrow = 3, xlim = c(0, 4), ylim = c(0, 10))
```

### GPP vs Soil Moisture

```{r gpp_vs_soil_moisture}
plot_against("dave_swvol", "dave_gpp",
             "Volumetric Soil Moisture", "GPP",
             "m3/m3", "gC/m2/day", ylim = c(0, 10))
```

### GPP vs VPD

```{r gpp_vs_vpd}
plot_against("dave_met_vpd", "dave_gpp",
             "VPD", "GPP",
             "kPa", "gC/m2/day", scales = "fixed")
```

### NEE vs PAR

```{r nee_vs_par}
plot_against("dave_met_insol", "dave_nee",
             "PAR", "NEE",
             "W/m2", "gC/m2/day", scales = "fixed")

plot_ratio("dave_met_insol", "dave_nee", "PAR", "NEE", "W/m2", "gC/m2/day")
plot_ratio("dave_met_insol", "dave_gpp", "PAR", "GPP", "W/m2", "gC/m2/day")
```

### GPP vs Linear Regression

```{r gpp_vs_linear_regression}
gpp <- read_data("dave_gpp")
gpp <- rename(gpp, predicted_gpp = src@name, gosif_gpp = "gosif-gpp")
par <- read_data("dave_met_insol")
par <- rename(par, observed_par = flux_rsds)
par <- par[, c("Year", "Day", "Site", "observed_par")]

data <- merge(gpp, par, by = c("Year", "Day", "Site"))

# Calculate a regression line from each *_gpp vs observed_par
gpp_cols <- c("predicted_gpp", "gosif_gpp", "flux_gpp")

# Build Date, guard against missing columns, and fit per-source regressions
data$date <- calc_date(data$Year, data$Day)
available_gpp <- intersect(gpp_cols, names(data))

for (col in available_gpp) {
    fit_col <- paste0(col, "_fit")
    # Robust fit ignoring NA
    df_fit <- data[, c(..col, "observed_par")]
    names(df_fit) <- c("gpp", "observed_par")
    model <- lm(gpp ~ observed_par, data = df_fit)
    data[[fit_col]] <- predict(model, newdata = data.frame(observed_par = data$observed_par))
}

# Long format: one color per source, linetype distinguishes data vs regression
plot_cols <- c(available_gpp, paste0(available_gpp, "_fit"))

data_long <- tidyr::pivot_longer(
    data,
    cols = all_of(plot_cols),
    names_to = "variable",
    values_to = "value"
) %>%
    dplyr::mutate(
        source = sub("_fit$", "", variable),
        type = ifelse(grepl("_fit$", variable), "regression", "data")
    )

# Optional: nicer labels for legend
label_map <- c(
    predicted_gpp = "Predicted",
    gosif_gpp = "GOSIF",
    flux_gpp = "Flux"
)

data_long$source_label <- dplyr::recode(data_long$source, !!!label_map)

ggplot(data_long, aes(x = date, y = value, color = type)) +
    geom_line() +
    facet_wrap(~ source_label, scales = "free_y") +
    scale_linetype_manual(values = c(data = "solid", regression = "dotted"), guide = "none") +
    labs(
        title = paste(site, "GPP vs PAR: Data and Linear Fits"),
        x = "Date",
        y = "GPP (gC/m2/day)",
        color = "GPP Source"
    ) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Test

```{r test}
vars <- c("dave_gpp", "dave_met_vpd", "dave_met_precip", "dave_met_temp", "dave_swvol")
ozflux_plot(src, vars, site, separate = TRUE)
data <- read_data(vars)
data$date <- calc_date(data$Year, data$Day)
outputs <- gsub("dave_", "", vars)
cols <- paste0(src@name, "_", outputs)

cols[1] <- "flux_gpp"
data_long <- pivot_longer(data, cols = cols, names_to = "variable", values_to = "value")
data_long <- data_long[complete.cases(data_long), ]
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = variable)) +
    facet_wrap(~ variable, scales = "free_y", ncol = 1) +
    ylab(NULL) +
    labs(title = paste(site, "Diagnostics")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

