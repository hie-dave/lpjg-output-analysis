---
title: "Ozflux Site Budget"
output:
    html_document:
        toc: true
        theme: united
        css: ozflux-benchmarks.css
        self_contained: true
params:
  repo: "~/code/lpj-guess/dave"
  source_id: "new"
  source_label: "MRS-NewCode"
  site: "CumberlandPlain"
  pft: "MRS"
  aspect_ratio: 0.6
  image_fmt: "svg"
  fig_width: 20
  dpi: 96
  retina: 2
  fig_align: "center"
  out_width: "100%"
---

```{r setup, include=FALSE, echo=FALSE}
library("daveanalysis")
library("ggpubr")
library("tidyr")
library("lubridate")
library("plotly")
library("dplyr")

# Read parameters from the Rmd 'params:' header (with defaults for ad-hoc runs)
repo <- params$repo
source_id <- params$source_id
source_label <- params$source_label
site <- params$site
pft <- params$pft

# Define the data source from parameters
# This will throw if source directory doesn't exist.
src <- defineSource(source_id, source_label, dir = repo, format = OZFLUX)

# knitr options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      out.width = params$out_width,
                      fig.asp = params$aspect_ratio,
                      dev = params$image_fmt,
                      dpi = params$dpi,
                      fig.retina = params$retina,
                      fig.align = params$fig_align,
                      fig.width = params$fig_width)

dave_config(log_level = 0)

# Set ggplot theme.
theme_set(theme_bw(base_size = 16))
```

```{r helper_functions}
use_colour <- function(plot, index, name) {
    colour <- daveanalysis:::get_colour_palette(index)[index]
    plot + scale_color_manual(values = colour, labels = c(name))
}

calc_date <- function(year, day) {
    return(as.Date(paste0(year, "-", day), format = "%Y-%j"))
}

rename_column <- function(df, old, new) {
    return(setNames(df, gsub(old, new, names(df))))
}

som_pools <- c("SURFSTRUCT", "SOILSTRUCT", "SOILMICRO", "SURFHUMUS",
               "SURFMICRO", "SURFMETA", "SURFFWD", "SURFCWD", "SOILMETA",
               "SLOWSOM", "PASSIVESOM", "total")
plot_sompool <- function(file, ylab, title, xlab = "Date") {
    library("ggplot2")
    data <- read_data(src, file, site, layers = som_pools)@data
    if ("Day" %in% names(data)) {
        data$date <- calc_date(data$Year, data$Day)
    } else {
        data$date <- data$Year
        if (missing(xlab)) {
            xlab <- "Year"
        }
    }
    data_long <- pivot_longer(data, cols = som_pools, names_to = "pool",
                              values_to = "value")

    # Convert from kg -> g
    data_long$value <- data_long$value * 1000
    data_long$pool <- factor(data_long$pool, levels = sort(som_pools))
    ggplot(data_long) +
        geom_line(aes(x = date, y = value, color = pool)) +
        facet_wrap(~ pool, scales = "free_y") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        xlab(xlab) +
        ylab(ylab) +
        labs(title = paste(site, title)) +
        theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
}

read_cton_live <- function(sources, pool, sites) {
    cmass <- read_data(sources, paste0("dave_cmass_", pool), sites)@data
    nmass <- read_data(sources, paste0("dave_nmass_", pool), sites)@data

    cton_min <- read_data(sources, paste0("dave_cton_", pool, "_min"), sites)
    cton_max <- read_data(sources, paste0("dave_cton_", pool, "_max"), sites)

    cton_min <- min(cton_min@data[[pft]])
    cton_max <- max(cton_max@data[[pft]])

    df <- merge(cmass, nmass, by = c("Lon", "Lat", "Year", "Day"))
    df <- setNames(df, c("Lon", "Lat", "Year", "Day", "cmass", "nmass"))

    df$cton_min <- cton_min
    df$cton_max <- cton_max

    df$cton <- df$cmass / df$nmass
    df$nmass_min <- df$cmass / df$cton_max
    df$nmass_max <- df$cmass / df$cton_min
    df$Date <- calc_date(df$Year, df$Day)
    return(df)
}
```

## Overview {.tabset}

The simulations in this document are based on the model before any changes were
made to the code, running TeBE only, limited to 1 cohort/1 patch.

### LAI

```{r benchmark_lai}
ozflux_panel(src, "dave_lai", site, show_all_observations = FALSE)
```

### GPP

```{r benchmark_gpp}
ozflux_panel(src, "dave_gpp", site)
```

### NEE

```{r benchmark_nee}
ozflux_panel(src, "dave_nee", site)
```

### Respiration

```{r benchmark_resp}
ozflux_panel(src, "dave_resp", site)
```

### ET

```{r benchmark_transpiration}
ozflux_panel(src, "dave_aet", site)
```

### Above-Ground Biomass

```{r benchmark_biomass}
ozflux_panel(src, "dave_aboveground_tree_biomass", site)
```

### Height

```{r benchmark_height}
ozflux_panel(src, "dave_height", site)
```

### Diameter

```{r benchmark_diameter}
ozflux_panel(src, "dave_diameter", site)
```

### Soil Moisture

```{r benchmark_soil_moisture}
ozflux_panel(src, "dave_swmm_100", site)
```

## Carbon Budget {.tabset}

### Annual Carbon Fluxes

```{r carbon_fluxes_annual}
# GPP, NPP, NEE, Respiration
acflux_vars <- c("dave_anee", "dave_anpp", "dave_agpp", "dave_aresp")
data <- read_data(src, acflux_vars, site)@data
renamed <- c("NEE", "NPP", "GPP", "Resp")
names(data) <- c("Lon", "Lat", "Year", renamed)
data_long <- pivot_longer(data, cols = renamed, names_to = "layer",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Carbon Flux (kgC/m2/year)") +
    labs(title = paste(site, "Carbon Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Carbon Fluxes

```{r carbon_fluxes_daily}
# TODO: break down respiration into growth/maintenance/etc
nee_data <- read_data(src, "dave_nee", site)@data
npp_data <- read_data(src, "dave_npp", site)@data
gpp_data <- read_data(src, "dave_gpp", site)@data
resp_data <- read_data(src, "dave_resp", site)@data

# Rename observed -> observed_flux and dave@name -> flux for all fluxes.
fix_names <- function(names, flux) {
    names <- gsub("observed", paste0("observed_", flux), names)
    names <- gsub(src@name, flux, names)
    return(names)
}
names(nee_data) <- fix_names(names(nee_data), "nee")
names(npp_data) <- fix_names(names(npp_data), "npp")
names(gpp_data) <- fix_names(names(gpp_data), "gpp")
names(resp_data) <- fix_names(names(resp_data), "resp")

# Drop Lon/Lat columns, as the data are already filtered by site.
nee_data <- select(nee_data, -Lon, -Lat)
npp_data <- select(npp_data, -Lon, -Lat)
gpp_data <- select(gpp_data, -Lon, -Lat)
resp_data <- select(resp_data, -Lon, -Lat)

data <- merge(nee_data, npp_data, by = c("Year", "Day"))
data <- merge(data, gpp_data, by = c("Year", "Day"))
data <- merge(data, resp_data, by = c("Year", "Day"))
data$date <- calc_date(data$Year, data$Day)

vars <- c("nee", "npp", "gpp", "resp")

predicted_cols <- intersect(vars, names(data))
observed_cols <- intersect(paste0("observed_", vars), names(data))

# Pivot predicted values
pred_long <- pivot_longer(
    data,
    cols = all_of(predicted_cols),
    names_to = "flux",
    values_to = "value"
) %>% mutate(source = "predicted")

# Pivot observed values (only for those that exist)
obs_long <- pivot_longer(
    data,
    cols = all_of(observed_cols),
    names_to = "col",
    values_to = "value"
) %>%
    mutate(
        flux = sub("^observed_", "", col),
        source = "observed"
    ) %>%
    select(-col)

# Combine
data_long <- bind_rows(pred_long, obs_long) %>%
    mutate(
        flux = factor(flux, levels = c("gpp", "npp", "nee", "resp")),
        source = factor(source, levels = c("predicted", "observed"))
    )

labeller <- c(nee = "NEE", npp = "NPP", gpp = "GPP", resp = "Resp")
# Faceted plot: one panel per flux, lines for observed vs predicted
ggplot(data_long) +
    geom_line(
        data = dplyr::filter(data_long, source == "observed"),
        aes(x = date, y = value, color = source)
    ) +
    geom_line(
        data = dplyr::filter(data_long, source == "predicted"),
        aes(x = date, y = value, color = source)
    ) +
    facet_wrap(
        ~ flux,
        scales = "free_y",
        ncol = 2,
        labeller = as_labeller(labeller)
    ) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("Date") +
    ylab("Carbon Flux (gC/m2/day)") +
    labs(title = paste(site, "Daily Carbon Fluxes"), color = "Type") +
    scale_color_manual(
        values = rev(daveanalysis:::get_colour_palette(2)),
        breaks = c("predicted", "observed"),
        labels = c("Predicted", "Observed")
    ) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Annual Carbon Pools

```{r carbon_pools_annual}
cpool_layers <- c("VegC", "LitterC", "SoilC", "Total")
data <- read_data(src, "cpool", site, layers = cpool_layers)@data
data_long <- pivot_longer(data, cols = cpool_layers, names_to = "layer",
                          values_to = "value") %>%
    dplyr::mutate(layer = factor(layer, levels = cpool_layers))
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("C Mass (kgC/m2)") +
    labs(title = paste(site, "Carbon Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Carbon Pools

```{r carbon_pools_daily}
cpool_layers <- c("VegC", "LitterC", "SoilC", "total")
data <- read_data(src, "dave_cpool", site, layers = cpool_layers)@data
data$date <- calc_date(data$Year, data$Day)
data_long <- pivot_longer(data, cols = cpool_layers, names_to = "layer",
                          values_to = "value") %>%
    dplyr::mutate(layer = factor(layer, levels = cpool_layers))

ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("Date") +
    ylab("C Mass (kgC/m2)") +
    labs(title = paste(site, "Carbon Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Respiration

```{r respiration}
vars <- c("maintenance", "growth")
data <- read_data(src, paste0("dave_resp_", vars), site)@data
data$date <- calc_date(data$Year, data$Day)
names(data) <- gsub(paste0(src@name, "_resp_"), "", names(data))
data_long <- pivot_longer(data, cols = vars, names_to = "respiration",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = respiration)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("Date") +
    ylab("Respiration (gC/m2/day)") +
    labs(title = paste(site, "Respiration")) +
    scale_color_manual(values = daveanalysis:::get_colour_palette(2)) +
    theme(plot.title = element_text(hjust = 0.5))
resp_data <- data
```

### Combined Carbon Fluxes


```{r combined_fluxes}
gpp_data <- read_data(src, "dave_gpp", site, read_obs = FALSE)@data
gpp_data$Lon <- NULL
gpp_data$Lat <- NULL
data <- merge(resp_data, gpp_data, by = c("Year", "Day"))
data$date <- calc_date(data$Year, data$Day)

data_long <- pivot_longer(data, cols = c("maintenance", "growth", "gpp"),
                          names_to = "flux", values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = flux)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("Date") +
    ylab("Flux (gC/m2/day)") +
    labs(title = paste(site, "Combined Carbon Fluxes")) +
    scale_color_manual(values = daveanalysis:::get_colour_palette(3)) +
    theme(plot.title = element_text(hjust = 0.5))
```

### Maintenance Respiration

```{r resp_maintenance}
pools <- c("leaf", "root", "sap")
outputs <- paste0("dave_resp_", pools)
data <- read_data(src, outputs, site)@data
data$date <- calc_date(data$Year, data$Day)
names(data) <- gsub(paste0(src@name, "_resp_"), "", names(data))
data_long <- pivot_longer(data, cols = pools, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("Date") +
    ylab("Respiration (gC/m2/day)") +
    labs(title = paste(site, "Maintenance Respiration")) +
    scale_color_manual(values = daveanalysis:::get_colour_palette(3)) +
    theme(plot.title = element_text(hjust = 0.5))
```

### CUE

```{r cue}
ozflux_plot(src, "dave_cue", site) +
    ylab("CUE (unitless)") +
    labs(title = paste(site, "Carbon Use Efficiency"))
```

## Nitrogen Budget {.tabset}

![](nitrogen-cycle.png)

### Sanity Check 0

This is a plot of this year's available N on the x-axis, against last year's
available N + this year's fluxes. If we have accounted for all of the fluxes
correctly, this should be a 1:1 line.

```{r anflux_sanity_check}
anflux_layers <- c("deposition", "fixation", "gross_mineralisation",
                   "immobilisation", "net_mineralisation", "min_leach",
                   "org_leach", "volatilisation", "gas_emissions", "flux",
                   "nuptake", "avail")
data <- read_data(src, "dave_nitrogen_budget_annual", site,
                  layers = anflux_layers)@data

data[, nmass_prev := data.table::shift(avail, 1)]
data[, nmass_expected := nmass_prev + flux]

r2 <- with(data[-1, ], cor(avail, nmass_expected)^2)

# Plot nmass and nmass_expected from row 2 to the end.
ggplot(data[-1, ], aes(x = avail, y = nmass_expected)) +
    geom_point() + labs(title = paste(site, "Expected vs Actual Available N")) +
    xlab("Actual (kgN/m2)") + ylab("Expected (kgN/m2)") +
    geom_text(
        x = -Inf, y = Inf,
        label = paste0("r2 = ", round(r2, 2)),
        hjust = -0.1, vjust = 1.25, size = 5
    )
anflux_data <- data
```

### Sanity Check 1

This is a plot of today's available N on the x-axis, against yesterday's
available N + today's fluxes. If we have accounted for all of the fluxes
correctly, this should be a 1:1 line.

```{r dnflux_sanity_check}
# Same order as anflux cols for comparison purposes
nflux_cols <- c("dNO3dep", "dNH4dep", "dnfix", "nmin_gross", "nimmob",
                "nmin_net", "norg_leach", "nmin_leach", "nvolatilisation",
                "nloss_gas", "flux", "nuptake", "avail")
data <- read_data(src, "dave_soil_nflux", site, layers = nflux_cols)@data
data$date <- calc_date(data$Year, data$Day)

data[, nmass_prev := data.table::shift(avail, 1)]
data[, nmass_expected := nmass_prev + flux]

r2 <- with(data[-1, ], cor(avail, nmass_expected)^2)

# Plot nmass and nmass_expected from row 2 to the end.
ggplot(data[-1, ], aes(x = avail, y = nmass_expected)) +
    geom_point() + labs(title = paste(site, "Expected vs Actual Available N")) +
    xlab("Actual (kgN/m2)") + ylab("Expected (kgN/m2)") +
    geom_text(
        x = -Inf, y = Inf,
        label = paste0("r2 = ", round(r2, 2)),
        hjust = -0.1, vjust = 1.25, size = 5
    )
dnflux_data <- data
```

### Daily Nitrogen Pools

```{r npool_daily}
npool_cols <- c("VegN", "LitterN", "SoilN", "AvailN")
data <- read_data(src, "dave_dnpool", site, layers = npool_cols)@data
data$date <- calc_date(data$Year, data$Day)

# Convert all layers from kgN to gN by multiplying by 1000.
for (col in npool_cols) {
    data[, (col) := (get(col)) * 1000]
}

df_long <- pivot_longer(data, cols = npool_cols, names_to = "layer",
                        values_to = "value")
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Nitrogen Pool (gN/m2)") +
    labs(title = paste(site, "Nitrogen Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Annual Nitrogen Fluxes

```{r anflux_avail}

# Convert all layers from kgN to gN by multiplying by 1000.
for (col in anflux_layers) {
    anflux_data[, (col) := (get(col)) * 1000]
}

df_long <- pivot_longer(anflux_data, cols = anflux_layers, names_to = "layer",
                        values_to = "value")
ggplot(df_long) +
    geom_line(aes(x = Year, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Nitrogen Flux (gN/m2/year)") +
    labs(title = paste(site, "Annual Nitrogen Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
rm(anflux_data)
```

### Daily Nitrogen Fluxes

```{r nflux_daily}
data <- dnflux_data

# Calculate deposition from dNO3dep and dNH4dep, and update nflux_cols
data[, deposition := dNO3dep + dNH4dep]
data[, dNO3dep := NULL]
data[, dNH4dep := NULL]

# Remove dNO3dep and dNH4dep from nflux_cols
nflux_cols <- setdiff(nflux_cols, c("dNO3dep", "dNH4dep"))
nflux_cols <- c("deposition", nflux_cols)

# Convert all layers from kgN to gN by multiplying by 1000.
for (col in nflux_cols) {
    data[, (col) := (get(col)) * 1000]
}

# Rename columns to be consistent with annual nitrogen outputs.
data <- rename_column(data, "dnfix", "fixation")
data <- rename_column(data, "nmin_gross", "gross_mineralisation")
data <- rename_column(data, "nimmob", "immobilisation")
data <- rename_column(data, "nmin_net", "net_mineralisation")
data <- rename_column(data, "norg_leach", "org_leach")
data <- rename_column(data, "nmin_leach", "min_leach")
data <- rename_column(data, "nvolatilisation", "volatilisation")
data <- rename_column(data, "nloss_gas", "gas_emissions")
data <- rename_column(data, "avail", "avail")

# Plot fluxes
df_long <- pivot_longer(data, cols = anflux_layers, names_to = "layer",
                        values_to = "value") %>%
    dplyr::mutate(layer = factor(layer, levels = sort(anflux_layers)))
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Nitrogen Flux (gN/m2/day)") +
    labs(title = paste(site, "Nitrogen Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
rm(dnflux_data)
```

## Water Budget {.tabset}

### Layerwise Soil Moisture

```{r soil_moisture}
sw_layers <- paste0("sw_", 0:14)
data <- read_data(src, "dave_sw", site, layers = sw_layers)@data
data$date <- calc_date(data$Year, data$Day)
df_long <- pivot_longer(data, cols = sw_layers, names_to = "layer",
                        values_to = "value")
df_long$layer_num <- as.integer(sub("^sw_", "", df_long$layer))
df_long$layer <- factor(df_long$layer,
                        levels = paste0("sw_", sort(unique(df_long$layer_num))))
labeller <- function(s) paste("layer", as.integer(sub("^sw_", "", s)))
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer,
               labeller = as_labeller(labeller)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Soil Moisture (0=Wilting Point, 1=Field Capacity)") +
    labs(title = paste(site, "Soil Moisture")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
# Plots to make:
# - wscal
# - layerwise soil moisture
# - fluxes ()
```

### Annual Water Fluxes

```{r awflux}
wflux_layers <- c("precip", "evap", "transp", "interception", "surfrunoff",
                  "drainrunoff", "baserunoff", "flux")
data <- read_data(src, "dave_water_budget_annual", site,
                  layers = wflux_layers)@data
data_long <- pivot_longer(data, cols = wflux_layers, names_to = "layer",
                          values_to = "value")
data_long$layer <- factor(data_long$layer, levels = wflux_layers)
ggplot(data_long) +
    geom_line(aes(x = Year, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Water Flux (mm/year)") +
    labs(title = paste(site, "Water Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Daily Water Fluxes

```{r water_fluxes}
data <- read_data(src, "dave_water_budget_daily", site, layers = wflux_layers)
data <- data@data
data$date <- calc_date(data$Year, data$Day)
df_long <- pivot_longer(data, cols = wflux_layers, names_to = "layer",
                        values_to = "value")
df_long$layer <- factor(df_long$layer, levels = wflux_layers)
ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = layer)) +
    facet_wrap(~ layer, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Water Flux (mm/day)") +
    labs(title = paste(site, "Water Fluxes")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

## SOM Pools {.tabset}

### Annual SOM Carbon

```{r asompool_c}
plot_sompool("dave_sompool_acmass", "Carbon Mass (gC/m2)", "SOM Carbon Mass")
```

### Daily SOM Carbon

```{r sompool_c}
plot_sompool("dave_sompool_cmass", "Carbon Mass (gC/m2)", "SOM Carbon Mass")
```

### Annual SOM Nitrogen

```{r asompool_n}
plot_sompool("dave_sompool_anmass", "Nitrogen Mass (gN/m2)",
             "SOM Nitrogen Mass")
```

### Daily SOM Nitrogen

```{r dsompool_n}
plot_sompool("dave_sompool_nmass", "Nitrogen Mass (gN/m2)",
             "SOM Nitrogen Mass")
```

### SOM Stoichiometry

```{r sompool_stoich}
cmass <- read_data(src, "dave_sompool_cmass", site, layers = som_pools)@data
nmass <- read_data(src, "dave_sompool_nmass", site, layers = som_pools)@data

data <- merge(cmass, nmass, by = c("Lon", "Lat", "Year", "Day"),
              suffixes = c("_cmass", "_nmass"))
data$date <- calc_date(data$Year, data$Day)

# Calculate cmass/nmass for each pool.
for (pool in som_pools) {
    cmass_col <- paste0(pool, "_cmass")
    nmass_col <- paste0(pool, "_nmass")
    data[[pool]] <- data[[cmass_col]] / data[[nmass_col]]
    data[[cmass_col]] <- NULL
    data[[nmass_col]] <- NULL
}

cton_min_slowsom <- 15
cton_max_slowsom <- 30
cton_min_soilmicro <- 6
cton_max_soilmicro <- 15
cton_min_surfhumus <- 15
cton_max_surfhumus <- 30
cton_min_surfmicro <- 10
cton_max_surfmicro <- 20

data_long <- pivot_longer(data, cols = som_pools, names_to = "pool",
                          values_to = "cton")
data_long$pool <- factor(data_long$pool, levels = sort(som_pools))

thresholds <- tribble(
    ~pool,         ~value,
    "SLOWSOM",     cton_min_slowsom,
    "SLOWSOM",     cton_max_slowsom,
    "SOILMICRO",   cton_min_soilmicro,
    "SOILMICRO",   cton_max_soilmicro,
    "SURFHUMUS",   cton_min_surfhumus,
    "SURFHUMUS",   cton_max_surfhumus,
    "SURFMICRO",   cton_min_surfmicro,
    "SURFMICRO",   cton_max_surfmicro
) %>% mutate(pool = factor(pool, levels = levels(data_long$pool)))

ggplot(data_long) +
    geom_line(aes(x = date, y = cton, color = pool)) +
    geom_hline(data = thresholds, aes(yintercept = value), linetype = "dotted",
               color = "black") +
    facet_wrap(~ pool, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("C:N ratio") +
    labs(title = paste(site, "SOM Pool C:N Ratios")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### SOM Immobilisation

```{r sompool_nimmob}
plot_sompool("dave_sompool_nimmob", "Immobilisation (gN/m2)",
             "SOM Nitrogen Immobilisation")
```

### SOM Gross Mineralisation

```{r sompool_nmin_gross}
plot_sompool("dave_sompool_nmin_gross", "Mineralisation (gN/m2)",
             "Gross Nitrogen Mineralisation")
```

### SOM Net Mineralisation

```{r sompool_nmin_net}
# Net mineralisation = gross mineralisation - immobilisation
nmin_gross <- read_data(src, "dave_sompool_nmin_gross", site,
                        layers = som_pools)@data
nmin_immob <- read_data(src, "dave_sompool_nimmob", site,
                        layers = som_pools)@data
data <- merge(nmin_gross, nmin_immob, by = c("Lon", "Lat", "Year", "Day"),
              suffixes = c("_gross", "_immob"))
for (pool in som_pools) {
    gross_col <- paste0(pool, "_gross")
    immob_col <- paste0(pool, "_immob")
    # Convert to grams at the same time.
    data[[pool]] <- (data[[gross_col]] - data[[immob_col]]) * 1000
    data[[gross_col]] <- NULL
    data[[immob_col]] <- NULL
}
data$date <- calc_date(data$Year, data$Day)
data_long <- pivot_longer(data, cols = som_pools, names_to = "pool",
                          values_to = "value")
data_long$pool <- factor(data_long$pool, levels = sort(som_pools))
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Net Mineralisation (gN/m2)") +
    labs(title = paste(site, "Net Mineralisation")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Normalised Net Mineralisation

```{r sompool_nmin_net_norm}
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Net Mineralisation (gN/m2)") +
    labs(title = paste(site, "Net Mineralisation")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Decay Reduction

```{r sompool_decay_reduction}
plot_sompool("dave_sompool_decay_reduction", "Decay Reduction (0-1)",
             "SOM Decay Reduction")
```

## Allocation {.tabset}

### Stress

```{r stress}
ggarrange(
    ggarrange(
        ozflux_plot(src, "dave_wscal", site) +
            ylab("wscal (0=no stress, 1=max stress)") +
            theme(legend.position = "none"),
        ozflux_plot(src, "dave_nscal", site) +
            ylab("nscal (0=no stress, 1=max stress)") +
            theme(legend.position = "none"),
        ncol = 2
    ),
    ozflux_plot(src, "dave_ltor", site) +
        ylab("Leaf:Root Ratio") +
        theme(legend.position = "none"),
    nrow = 2
)
```

### Carbon Allocation

```{r calloc}
layers <- c("dave_cmass_leaf", "dave_cmass_leaf_limit",
            "dave_cmass_root", "dave_cmass_root_limit",
            "dave_cmass_sap", "dave_cmass_sap_limit",
            "dave_cmass_storage", "dave_cmass_storage_limit",
            "dave_alpha_leaf", "dave_alpha_root",
            "dave_alpha_sap", "dave_alpha_storage",
            "dave_cgrow_leaf", "dave_cgrow_root",
            "dave_cgrow_sap", "dave_cgrow_storage")

df <- read_data(src, layers, site, layers = pft)@data
df$date <- as.Date(paste0(df$Year, "-", df$Day), format = "%Y-%j")
# Replace e.g. "dave_cmass_leaf" with "MRS_cmass_leaf"
names <- gsub("dave_", "", layers)
# Rename exactly "MRS" to MRS_cmass_leaf
names(df) <- gsub(paste0(src@name, "_"), "", names(df))

df_long <- pivot_longer(df, cols = names, names_to = "layer",
                        values_to = "value") %>%
    mutate(component = sub("_limit$", "", layer),
           type = ifelse(grepl("_limit$", layer), "limit", "biomass"))

ggplot(df_long) +
    geom_line(aes(x = date, y = value, color = type)) +
    facet_wrap(~ component, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_color_manual(values = daveanalysis:::get_colour_palette(2),
                       labels = c("actual", "limit")) +
    theme(legend.position = "none")
```

### Annual Carbon Allocation

```{r acalloc}
pools <- c("leaf", "root", "sap", "storage")
alpha_layers <- paste0("dave_alpha_", pools)
cgrow_layers <- paste0("dave_cgrow_", pools)

alpha_data <- read_data(src, alpha_layers, site)@data
cgrow_data <- read_data(src, cgrow_layers, site)@data

names(alpha_data) <- gsub(paste0(src@name, "_"), "", names(alpha_data))
names(cgrow_data) <- gsub(paste0(src@name, "_"), "", names(cgrow_data))

# Aggregate to annual values. Alphas: mean, Cgrow: sum
alpha_data <- aggregate(alpha_data, by = list(alpha_data$Year), mean)
# Sums all non-grouping columns by Year; Year is not summed
cgrow_data <- aggregate(. ~ Year, data = cgrow_data, FUN = sum, na.rm = TRUE)

data <- merge(alpha_data, cgrow_data, by = "Year")

# Build a simple long-format data frame from your existing `data`
# Assumes data contains columns: Year, alpha_*, cgrow_*, for all pools.
alpha_name <- "Alpha (unitless)"
cgrow_name <- "Cgrow (kgC/m2)"
data_long <- data %>%
    pivot_longer(
        cols = matches("^(alpha_|cgrow_)"),
        names_to = "layer",
        values_to = "value"
    ) %>%
    mutate(
        quantity = if_else(str_starts(layer, "alpha_"),
                           alpha_name, cgrow_name),
        pool = str_remove(layer, "^(alpha_|cgrow_)"),
        pool = factor(pool, levels = pools),
        quantity = factor(quantity, levels = c(alpha_name, cgrow_name))
    )

ggplot(data_long, aes(x = Year, y = value, color = pool)) +
    geom_line() +
    facet_grid(quantity ~ ., scales = "free_y", switch = "y") +
    labs(x = "Year", y = NULL,
         title = paste(site, "Annual Carbon Allocation")) +
    theme(strip.placement = "outside",
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "bottom")
```

### Carbon Allocation Distribution

```{r calloc_dist}
# Boxplot distribution of annual alpha and cgrow by pool
# Assumes `data` contains columns Year, alpha_*, cgrow_* and `pools` exists

# Long format with pool and quantity
df_box <- data %>%
    pivot_longer(
        cols = matches("^(alpha_|cgrow_)"),
        names_to = "layer",
        values_to = "value"
    ) %>%
    mutate(
        quantity = if_else(str_starts(layer, "alpha_"), alpha_name, cgrow_name),
        pool = str_remove(layer, "^(alpha_|cgrow_)"),
        pool = factor(pool, levels = pools),
        quantity = factor(quantity, levels = c(alpha_name, cgrow_name))
    )

# Faceted panel: top = alpha, bottom = cgrow; one box per pool
ggplot(df_box, aes(x = pool, y = value, fill = pool)) +
    geom_boxplot(outlier.alpha = 0.5) +
    facet_grid(quantity ~ ., scales = "free_y", switch = "y") +
    labs(x = "Pool", y = NULL,
         title = paste(site, "Distribution of Annual Carbon Allocation")) +
    theme(strip.placement = "outside",
          strip.text.y.left = element_text(angle = 0),
          axis.text.x = element_text(angle = 90, hjust = 1))
```

### Vegetation Carbon Pools

```{r cpool_veg}
layers <- c("leaf", "root", "sap", "storage", "repr")
outputs <- paste0("dave_cmass_", layers)
data <- read_data(src, outputs, site)@data
data$date <- calc_date(data$Year, data$Day)

# Rename e.g. MRS_cmass_leaf to leaf
names(data) <- gsub(paste0(src@name, "_cmass_"), "", names(data))

data_long <- pivot_longer(data, cols = layers, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Carbon Mass (kgC/m2)") +
    labs(title = paste(site, "Vegetation Carbon Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Vegetation Nitrogen Pools

```{r npool_veg}
outputs <- paste0("dave_nmass_", layers)
data <- read_data(src, outputs, site)@data
data$date <- calc_date(data$Year, data$Day)

# Rename e.g. MRS_cmass_leaf to leaf
names(data) <- gsub(paste0(src@name, "_nmass_"), "", names(data))

data_long <- pivot_longer(data, cols = layers, names_to = "pool",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = pool)) +
    facet_wrap(~ pool, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Nitrogen Mass (kgN/m2)") +
    labs(title = paste(site, "Vegetation Nitrogen Pools")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Stoichiometry

```{r stoichiometry}
read_cton <- function(pool) {
    data <- read_cton_live(src, pool, site)
    data <- data[, c("Date", "cton_min", "cton", "cton_max")]
    names(data) <- c(
        "Date",
        paste0("cton_", pool, "_min"),
        paste0("cton_", pool),
        paste0("cton_", pool, "_max")
    )
    return(data)
}
cton_leaf <- read_cton("leaf")
cton_root <- read_cton("root")
cton_sap <- read_cton("sap")
cton <- merge(cton_leaf, cton_root, by = "Date")
cton <- merge(cton, cton_sap, by = "Date")
cton_long <- pivot_longer(
    cton,
    cols = starts_with("cton_"),
    names_to = c("metric", "pool", "bound"),
    names_pattern = "(cton)_(leaf|root|sap)(?:_(min|max))?",
    values_to = "value"
)
cton_long$pool <- factor(cton_long$pool, levels = c("leaf", "root", "sap"))
cton_actual <- dplyr::filter(cton_long, bound == "")
cton_bounds <- dplyr::filter(cton_long, bound != "")

ggplot() +
    geom_line(data = cton_actual, aes(x = Date, y = value, color = pool)) +
    geom_line(data = dplyr::filter(cton_bounds, bound == "min"),
              aes(x = Date, y = value), linetype = "dashed", color = "grey40") +
    geom_line(data = dplyr::filter(cton_bounds, bound == "max"),
              aes(x = Date, y = value), linetype = "dashed", color = "grey40") +
    facet_wrap(~ pool, scales = "free_y") +
    labs(title = paste(site, "Stoichiometry"), x = "Date", y = "C:N Ratio")

```

### Stoichiometry Normalised

```{r stoichiometry_normalised}
# Normalised position within [min, max] per pool
cton_norm <- with(cton, data.frame(
    Date = Date,
    leaf = (cton_leaf - cton_leaf_min) / (cton_leaf_max - cton_leaf_min),
    root = (cton_root - cton_root_min) / (cton_root_max - cton_root_min),
    sap  = (cton_sap  - cton_sap_min)  / (cton_sap_max  - cton_sap_min)
))

# Handle divisions by zero or invalid values
is_bad <- function(x) !is.finite(x)
cton_norm$leaf[is_bad(cton_norm$leaf)] <- NA_real_
cton_norm$root[is_bad(cton_norm$root)] <- NA_real_
cton_norm$sap[is_bad(cton_norm$sap)]   <- NA_real_

# Optionally clamp to [0,1]
cton_norm$leaf <- pmin(pmax(cton_norm$leaf, 0), 1)
cton_norm$root <- pmin(pmax(cton_norm$root, 0), 1)
cton_norm$sap  <- pmin(pmax(cton_norm$sap,  0), 1)

cton_norm_long <- pivot_longer(cton_norm, cols = c("leaf", "root", "sap"),
                               names_to = "pool", values_to = "norm")

ggplot(cton_norm_long) +
    geom_line(aes(x = Date, y = norm, color = pool)) +
    scale_y_continuous(limits = c(0, 1)) +
    labs(title = paste(site, "Normalised Stoichiometry Position"),
         x = "Date", y = "(cton - min) / (max - min)") +
    theme(plot.title = element_text(hjust = 0.5))
```

### Allometry

```{r allometry}
# fixme: eliminate whitespace
vars <- c("dave_height", "dave_diameter", "dave_basalarea", "dave_density")
data <- read_data(src, vars, site, read_obs = FALSE)@data
data$date <- calc_date(data$Year, data$Day)
var_names <- gsub("dave_", "", vars)
names(data) <- gsub(paste0(src@name, "_"), "", names(data))
data_long <- pivot_longer(data, cols = var_names, names_to = "variable",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = variable)) +
    facet_wrap(~ variable, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Value (m)") +
    labs(title = paste(site, "Allometry")) +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

### Diagnostics

```{r diagnostics}
vars <- c("dave_latosa", "dave_cue")
data <- read_data(src, vars, site, read_obs = FALSE)@data
names(data) <- gsub(paste0(src@name, "_"), "", names(data))
data$date <- calc_date(data$Year, data$Day)
newnames <- gsub("dave_", "", vars)
data_long <- pivot_longer(data, cols = newnames, names_to = "variable",
                          values_to = "value")
ggplot(data_long) +
    geom_line(aes(x = date, y = value, color = variable)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab(NULL) +
    labs(title = paste(site, "Diagnostics")) +
    theme(plot.title = element_text(hjust = 0.5))
```
