---
title: "TellAus Benchmark Report for LPJ-GUESS DAVE"
author: "Drew Holzworth"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output:
 html_document:
  toc: true
params:
  new_directory:
    value: "/home/drew/code/lpj-guess/output-analysis/.data/runs/dave/baseline"
  new_name:
    value: "DAVE"
  old_directory:
    value: "/home/drew/code/lpj-guess/output-analysis/.data/runs/trunk/grass"
  old_name:
    value: "GrassTrunk"
  data_directory:
    value: "/home/drew/code/lpj-guess/output-analysis/.data"
---

```{r benchmark selection and script parameters, echo=FALSE}

### Select which benchmarks to do
do_auseflux_gpp <- FALSE
do_auseflux_nee <- TRUE
do_auseflux_er <- FALSE
do_grass_dist <- FALSE
do_bom_lai <- FALSE

debug <- FALSE

# Global script parameters.
settings <- list(
    data_path = "/home/drew/code/lpj-guess/output-analysis/.data",

    analysis_version = "tellme_dave v0.1",

    plot_maps = TRUE,

    # Spatial extent for which data will be plotted. This can be:
    # - raster::extent
    # - two-column data.frame of gridcells
    # - NULL (to plot the entire spatial extent of the data)
    spatial_extent = NULL,

    # String used to describe the spatial subset.
    spatial_extent_id = "Australia",

    # Plot formatting arguments.
    map_overlay = "coastlines",

    # ME (Mean Error)
    # NME (Normalised Mean Error)
    # NMSE (Normalised Mean Square Error)
    # RMSE (Root Mean Squared Error)
    # NME_2 (NME with mean removed)
    # NMSE_2 (NMSE with mean removed)
    # NME_3 (NME with mean and variance removed)
    # NMSE_3 (NMSE with mean and variance removed)
    # r2_eff (Nash-Sutcliffe Model Efficiency)
    # r2 (Coefficient of Determination)
    # r (Pearson's PMCC)
    # m (gradient of linear fit mod = m * obs + c)
    # c (intercept of linear fit mod = m * obs + c)
    metrics = c("r2", "RMSE", "NMSE", "r2_eff"),

    text_multiplier = 2.5,

    annotation_text_size = 7,

    # Number of columns in which plots will be rendered.
    num_cols = 2,

    # Coordinates at which metrics/annotations will be rendered on maps.
    stats_lon = 125,
    stats_lat = -35,

    # The two time periods used for comparison of C3/C4 grass distribution.
    # The first time period is defined by the first two numbers.
    # The second time period is defined by the third and fourth numbers.
    grass_dist_years = c(1980, 1989, 2013, 2022)
)
```

```{r setup, include=FALSE}
# knitr options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      out.width = "100%",
                      fig.height = 7,
                      warning = debug)

# kable options
opts <- options(knitr.kable.NA = "")

library("ggplot2")

# Set ggplot theme.
theme_set(theme_bw())

library("DGVMTools")
library("daveanalysis")
library("terra")
library("viridis")
library("mapproj")
library("pals")
library("knitr")
library("dplyr")
library("kableExtra")
library("tictoc")
library("lubridate")

# This helps RMarkdown locate fonts on some systems.
library("showtext")
showtext_auto()

# Start timer.
tic()
```

# Settings {.tabset}

## Click here to hide Settings

## Click here to show settings

```{r settings}
dave_source <- defineSource(name = params$new_name,
                            dir = params$new_directory,
                            format = GUESS)
trunk_source <- defineSource(name = params$old_name,
                             dir = params$old_directory,
                             format = GUESS)

# Create a list of sources and store it in script settings.
settings$simulations <- list(dave_source, trunk_source)

for (sim in settings$simulations) {
    cat(sim@name, ": ", sim@dir, "\n")
}
```

```{r silent preamble and preparation}
version_label <- paste(settings$analysis_version, settings$spatial_extent_id
                       , sep = "_")

# Prepare empty summary table of global numbers.
summary_col_names <- c("Quantity", "Unit")
for (simulation in settings$simulations) {
    summary_col_names <- append(summary_col_names, simulation@name)
}
summary_col_names <- append(summary_col_names
                            , c("Data", "Dataset", "Dataset ref."))
settings$summary_col_names <- summary_col_names

summary_table <- data.frame(check.names = FALSE, stringsAsFactors = FALSE)

# This table is completely empty; it will by built benchmark by benchmark.
metric_table <- data.frame(check.names = FALSE, stringsAsFactors = FALSE)

# This list contains tables that gets passed in and out of each benchmark.
overall_tables <- list(
    totals = summary_table,
    metrics = metric_table
)

# Fix overlapping x-axis labels by removing the overlapping labels.
fix_xaxis_label_overlap <- function(plt) {
    xlim <- layer_scales(plt)$x$get_limits()
    guide <- guide_axis(check.overlap = TRUE)
    return(plt + scale_x_continuous(guide = guide, limits = xlim))
}
print_plot <- function(plt) {
    plt <- fix_xaxis_label_overlap(plt)
    print(plt)
}
```

***

# BoM LAI

Potential intro text about Luigi's LAI data, links to online description of the
data, what to look for in the benchmark, etc.

```{r luigi_lai}
if (do_bom_lai) {
    bom_lai <- benchmark_bom_lai(settings = settings,
                                 params = params,
                                 tables_list = overall_tables)
}
```

## Spatial patterns {.tabset}

### Absolute Values

```{r bom_lai_plots_absolute_values}
if (do_bom_lai && settings$plot_maps) {
    first_year <- bom_lai$benchmark@first.year
    last_year <- bom_lai$benchmark@last.year
    subtitle <- paste(first_year, last_year, sep = "-")
    plt <- plotSpatial(bom_lai$maps,
                                ncol = settings$num_cols,
                                legend.title = expression(m^{"2"}~m^{"-2"}),
                                map.overlay = settings$map_overlay,
                                text.multiplier = settings$text_multiplier,
                                title = "Absolute LAI values",
                                limits = c(0, 8),
                                subtitle = subtitle)
    # total_label_df <- data.frame()
    # for (panel in names(bom_lai$maps)) {
    #     total_label_df <- rbind(total_label_df, list(
    #         label = paste(round(rnorm(1) + 2)),
    #         Facet = panel,
    #         x = settings$stats_lon, y = settings$stats_lat
    #     ), stringsAsFactors = FALSE)
    # }
    # total_label_df$Facet <- factor(total_label_df$Facet,
    #                                levels = names(bom_lai$maps))
    # txt <- geom_text(data = total_label_df,
    #                  mapping = aes(x = x, y = y, label = label),
    #                  size = settings$map_annotation_text_size)
    # bom_lai_abs_plot <- bom_lai_abs_plot + txt
    print_plot(plt)
}
```

### Differences

```{r bom_lai_plots_deltas}
if (do_bom_lai && settings$plot_maps) {
    # Set ggplot theme.
    theme_set(theme_bw())

    comparisons <- bom_lai$comparisons[["Values"]]

    plt <- plotSpatialComparison(
        comparisons,
        ncol = settings$num_cols,
        legend.title = expression(Delta ~ m^{"2"} ~ m^{"-2"}),
        text.multiplier = settings$text_multiplier,
        map.overlay = settings$map_overlay,
        title = "LAI biases",
        subtitle = paste("2000", "2022", sep = "-"),
        panel.bg.col = "white"
    )
    lat_offset <- 0
    cnames <- names(comparisons)
    for (metric in bom_lai$benchmark@metrics) {
        metric_label_df <- data.frame()
        for (comparison_name in cnames) {
            value <- round(comparisons[[comparison_name]]@stats[[metric]], 2)
            metric_label_df <- rbind(metric_label_df,
                                list(label = paste(metric, "=", value),
                                     Facet = comparison_name,
                                     x = settings$stats_lon,
                                     y = settings$stats_lat - lat_offset),
                                stringsAsFactors = FALSE)
        }
        metric_label_df$Facet <- factor(metric_label_df$Facet, cnames)
        plt <- plt + geom_text(data = metric_label_df, mapping = aes(x = x, y = y, label = label), size = settings$annotation_text_size)
        lat_offset <- lat_offset + 10
    }
    print_plot(plt)
}
```

## Temporal trends {.tabset}

### Trend value

```{r bom_lai_plots_trend_values}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatial(bom_lai$trends
                       , layers = "Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-0.01, 0.01)
                       , drop.cuts = FALSE
                       , title = "Trend in LAI"
                       , legend.title =expression(m^{"2"}~m^{"-2"}~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = subtitle)
    print_plot(plt)
}
```

### Trend Significance

```{r bom_lai_plots_trend_significance}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatial(bom_lai$trends
                       , layers = "p.value"
                       , ncol = settings$num_cols
                       , cols = viridis::turbo(6)
                       , cuts = c(0, 0.001, 0.01, 0.05, 0.1, 0.5, 1.0)
                       , drop.cuts = FALSE
                       , title = "Significance in LAI Trends"
                       , legend.title = "p value"
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = subtitle)
    print_plot(plt)
}
```

### Trend Differences

```{r bom_lai_plots_trend_deltas}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatialComparison(bom_lai$comparisons[["Trend"]]
                                 , ncol = settings$num_cols
                                 , drop.cuts = NULL
                                 , title = "Difference Trend in LAI"
                                 , legend.title = expression(m^{"2"}~m^{"-2"}~month^{"-2"})
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = subtitle)
    print_plot(plt)
}
```

### Significant Trends

```{r bom_lai_plots_trends}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatial(bom_lai$trends
                       , layers = "Significant_Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-0.01, 0.01)
                       , drop.cuts = FALSE
                       , title = "Significant Trend in LAI (p-value < 0.05)"
                       , legend.title = expression(m^{"2"}~m^{"-2"}~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = subtitle)
    print_plot(plt)
}
```

## Seasonal Analysis {.tabset}

Definition of seasonal concentration and phase follow Kelley *et al.* 2013. **Seasonal concentration** equals one if the variable is concentrated all in one month, and is zero if it is spread evenly across all months.  The **seasonal phase** is a measure of the peak of the season - it is not strictly the maximum monthly, but rather the average of all months when considering months as an angle in the complex plane.

### Seasonal Phase

```{r bom_lai_plots_phases}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatialComparison(bom_lai$comparisons[["Seasonal"]]
                                 , do.phase = TRUE
                                 , type = "values"
                                 , cuts = 0:12
                                 , override.cols = pals::ocean.phase(12)
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = subtitle)
    print_plot(plt)
}
```

### Phase Differences

```{r bom_lai_plots_phase_deltas}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatialComparison(bom_lai$comparisons[["Seasonal"]]
                                 , do.phase = TRUE
                                 , cuts = seq(-6, 6)
                                 , symmetric.scale = FALSE
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = subtitle)
    print_plot(plt)
}
```

### Seasonal Concentration

```{r bom_lai_plots_seasonsal_concentration}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatialComparison(bom_lai$comparisons[["Seasonal"]]
                                 , type = "values"
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = subtitle)
    print_plot(plt)
}
```

### Concentration Differences

```{r bom_lai_plots_concentration_deltas}
if (do_bom_lai && settings$plot_maps) {
    plt <- plotSpatialComparison(bom_lai$comparisons[["Seasonal"]]
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = subtitle)
    print_plot(plt)
}
```

## {.unlisted .unnumbered}

<a href="#top">Back to top</a>

# C3/C4 Distribution

```{r grass_dist}
if (do_grass_dist) {
    grass_benchmark <- benchmark_grass_dist(settings, params, overall_tables)
    grass_first_year <- min(grass_benchmark$trends[[1]]@first.year)
    grass_last_year <- max(grass_benchmark$trends[[1]]@last.year)
    grass_subtitle <- paste(grass_first_year, grass_last_year, sep = "-")
    grass_delta_subtitle <- paste0(params$new_name, " - ", params$old_name
                                   , " (", grass_subtitle, ")")
}
```

## Spatial Patterns (Fixed Time Period) {.tabset}

```{r}
cat("Spatial patterns for ", length(years), " time periods\n")
```

### Absolute Values

```{r grass_dist_plots_abs}
if (do_grass_dist && settings$plot_maps) {
    plt <- plotSpatial(grass_benchmark$period_maps
                       , legend.title = expression(1)
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , title = "C4 Fraction")
                       #, subtitle = subtitle)
    print_plot(plt)
}
```

### Differences

```{r grass_dist_plots_deltas}
if (do_grass_dist && settings$plot_maps) {
    years <- settings$grass_dist_years
    r0 <- paste0(years[1], "-", years[2])
    r1 <- paste0(years[3], "-", years[4])
    title <- paste0("C4 Fraction Change from (", r0, ") - (", r1, ")")
    plt <- plotSpatial(grass_benchmark$diffs
                       , legend.title = expression((0-1))
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , title = title
                       , subtitle = character(0)
                       , panel.bg.col = "white"
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu")))
    print_plot(plt)
}
```

## Spatial Patterns (Full Time Period) {.tabset}

### Absolute Values

```{r grass_dist_plots_abs_values}
if (do_grass_dist && settings$plot_maps) {
    plt <- plotSpatial(grass_benchmark$means
                       , ncol = settings$num_cols
                       , legend.title = expression((0-1))
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , title = "C4 Fraction"
                       , subtitle = grass_subtitle)
    print_plot(plt)
}
```

### Differences

```{r grass_dist_plots_abs_differences}
if (do_grass_dist && settings$plot_maps) {
    plt <- plotSpatialComparison(grass_benchmark$comparisons[["Values"]]
                                 , ncol = settings$num_cols
                                 , legend.title = expression(Delta)
                                 , text.multiplier = settings$text_multiplier
                                 , map.overlay = settings$map_overlay
                                 , title = "C4 Fraction Biases"
                                 , subtitle = grass_delta_subtitle
                                 , panel.bg.col = "white")
    print_plot(plt)
}
```

## Temporal Trends {.tabset}

### Trend Value

```{r grass_dist_plots_trend_values}
if (do_grass_dist && settings$plot_maps) {
    plt <- plotSpatial(grass_benchmark$trends
                       , layers = "Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-6e-5, 6e-5)
                       , drop.cuts = FALSE
                       , title = "Trend in C4 Fraction"
                       , legend.title = expression(~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier)
    print_plot(plt)
}
```

### Trend Significances

```{r grass_dist_plots_trend_significances}
if (do_grass_dist && settings$plot_maps) {
    plt <- plotSpatial(grass_benchmark$trends
                       , layers = "p.value"
                       , ncol = settings$num_cols
                       , cols = viridis::turbo(6)
                       , cuts = c(0, 0.001, 0.01, 0.05, 0.1, 0.5, 1.0)
                       , drop.cuts = FALSE
                       , title = "Significance in C4 Fraction Trends"
                       , legend.title = "p value"
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = grass_subtitle)
    print_plot(plt)
}
```

### Trend Differences

```{r grass_dist_plots_trend_deltas}
if (do_grass_dist && settings$plot_maps) {
    plt <- plotSpatialComparison(grass_benchmark$comparisons[["Trend"]]
                                 , ncol = settings$num_cols
                                 , drop.cuts = NULL
                                 , title = "Difference Trend in C4 Fraction"
                                 , legend.title = expression((0-1))
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = grass_subtitle)
    print_plot(plt)
}
```

### Significant Trends

```{r grass_dist_plots_significant_trends}
if (do_grass_dist && settings$plot_maps) {
    plt <- plotSpatial(grass_benchmark$trends
                       , layers = "Significant_Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-0.01, 0.01)
                       , drop.cuts = FALSE
                       , title = "Significant Trend in LAI (p-value < 0.05)"
                       , legend.title = expression(m^{"2"}~m^{"-2"}~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = grass_subtitle)
    print_plot(plt)
}
# todo: add seasonal analysis once we have observations of c3/c4 distribution
```

# AusEFlux GPP

Intro, data links, etc.

```{r auseflux_gpp}
if (do_auseflux_gpp) {
    auseflux_gpp <- benchmark_auseflux("GPP", settings, params, overall_tables)
    benchmark <- auseflux_gpp$benchmark
    auseflux_subtitle <- paste0(benchmark@first.year, "-", benchmark@last.year)
}
```

## Spatial Patterns {.tabset}

### Absolute Values

```{r auseflux_gpp_plots_absolute}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatial(auseflux_gpp$maps
                       , ncol = settings$num_cols
                       , legend.title = expression(gC~m^{"-2"}~year^{"-1"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , title = "Absolute GPP values"
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Differences

```{r auseflux_gpp_plots_deltas}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_gpp$comparisons[["Values"]]
                                 , ncol = settings$num_cols
                                 , legend.title = expression(Delta~gC~m^{"-2"}~year^{"-1"})
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , title = "GPP biases"
                                 , subtitle = auseflux_subtitle
                                 , panel.bg.col = "white")
    print_plot(plt)
}
```

## Temporal Trends {.tabset}

### Trend Value

```{r auseflux_gpp_plots_trend_values}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatial(auseflux_gpp$trends
                       , layers = "Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-0.01, 0.01)
                       , drop.cuts = FALSE
                       , title = "Trend in GPP"
                       , legend.title = expression(gC~m^{"-2"}~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Trend Significance

```{r auseflux_gpp_plots_trend_significance}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatial(auseflux_gpp$trends
                       , layers = "p.value"
                       , ncol = settings$num_cols
                       , cols = viridis::turbo(6)
                       , cuts = c(0, 0.001, 0.01, 0.05, 0.1, 0.5, 1.0)
                       , drop.cuts = FALSE
                       , title = "Significance in GPP Trends"
                       , legend.title = "p value"
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Trend Differences

```{r auseflux_gpp_plots_trend_deltas}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_gpp$comparisons[["Trend"]]
                                 , ncol = settings$num_cols
                                 , drop.cuts = NULL
                                 , title = "Difference Trend in GPP"
                                 , legend.title = expression(Delta~gC~m^{"-2"}~month^{"-2"})
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Significant Trends

```{r auseflux_gpp_plots_significant_trends}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatial(auseflux_gpp$trends
                       , layers = "Significant_Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-0.01, 0.01)
                       , drop.cuts = FALSE
                       , title = "Significant Trend in GPP (p-value < 0.05)"
                       , legend.title = expression(gC~m^{"-2"}~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

## Seasonal Analysis {.tabset}

Definition of seasonal concentration and phase follow Kelley *et al.* 2013.  **Seasonal concentration** equals one if the variable is concentrated all in one month, and is zero if it is spread even across all months.  The **seasonal phase** is a measure of the peak of the season - it is not strictly the maximum monthly, but rather the average of all months when considering months as an angle in the complex plane.  

### Seasonal Phase

```{r auseflux_gpp_plots_phases}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_gpp$comparisons[["Seasonal"]]
                                 , do.phase = TRUE
                                 , type = "values"
                                 , cuts = 0:12
                                 , override.cols = pals::ocean.phase(12)
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Phase Differences

```{r auseflux_gpp_plots_phase_deltas}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_gpp$comparisons[["Seasonal"]]
                                 , do.phase = TRUE
                                 , cuts = seq(-6, 6)
                                 , symmetric.scale = FALSE
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Seasonal Concentration

```{r auseflux_gpp_plots_seasonal_concentration}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_gpp$comparisons[["Seasonal"]]
                                 , type = "values"
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Concentration Differences

```{r auseflux_gpp_plots_concentration_deltas}
if (do_auseflux_gpp && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_gpp$comparisons[["Seasonal"]]
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

## {.unlisted .unnumbered}

<a href="#top">Back to top</a>

# AusEFlux NEE

Intro, data links, etc.

```{r auseflux_nee}
if (do_auseflux_nee) {
    auseflux_nee <- benchmark_auseflux("NEE", settings, params, overall_tables)
    benchmark <- auseflux_nee$benchmark
    auseflux_subtitle <- paste0(benchmark@first.year, "-", benchmark@last.year)
}
```

## Spatial Patterns {.tabset}

### Absolute Values

```{r auseflux_nee_plots_absolute}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatial(auseflux_nee$maps
                       , ncol = settings$num_cols
                       , legend.title = expression(gC~m^{"-2"}~year^{"-1"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , title = "Absolute NEE Values"
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Differences

```{r auseflux_nee_plots_deltas}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_nee$comparisons[["Values"]]
                                 , ncol = settings$num_cols
                                 , legend.title = expression(Delta~gC~m^{"-2"}~year^{"-1"})
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , title = "NEE biases"
                                 , subtitle = auseflux_subtitle
                                 , panel.bg.col = "white")
    print_plot(plt)
}
```

## Temporal Trends {.tabset}

### Trend Value

```{r auseflux_nee_plots_trend_values}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatial(auseflux_nee$trends
                       , layers = "Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-0.01, 0.01)
                       , drop.cuts = FALSE
                       , title = "Trend in NEE"
                       , legend.title = expression(gC~m^{"-2"}~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Trend Significance

```{r auseflux_nee_plots_trend_significance}
# TODO: create a variable for cuts, and change the 6 in the number of colours
# to be the length of this variable.
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatial(auseflux_nee$trends
                       , layers = "p.value"
                       , ncol = settings$num_cols
                       , cols = viridis::turbo(6)
                       , cuts = c(0, 0.001, 0.01, 0.05, 0.1, 0.5, 1.0)
                       , drop.cuts = FALSE
                       , title = "Signifiance in NEE Trends"
                       , legend.title = "p value"
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Trend Differences

```{r auseflux_nee_plots_trend_deltas}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_nee$comparisons[["Trend"]]
                                 , ncol = settings$num_cols
                                 , drop.cuts = NULL
                                 , title = "Difference Trend in NEE"
                                 , legend.title = expression(Delta~gC~m^{"-2"}~month^{"-2"})
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Significant Trends

```{r auseflux_nee_plots_significant_trends}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatial(auseflux_nee$trends
                       , layers = "Significant_Trend"
                       , ncol = settings$num_cols
                       , cols = rev(RColorBrewer::brewer.pal(11, "RdBu"))
                       , limits = c(-0.01, 0.01)
                       , drop.cuts = FALSE
                       , title = "Significant Trend in NEE (p-value < 0.05)"
                       , legend.title = expression(gC~m^{"-2"}~month^{"-2"})
                       , map.overlay = settings$map_overlay
                       , text.multiplier = settings$text_multiplier
                       , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

## Seasonal Analysis {.tabset}

Definition of seasonal concentration and phase follow Kelley *et al.* 2013.  **Seasonal concentration** equals one if the variable is concentrated all in one month, and is zero if it is spread even across all months.  The **seasonal phase** is a measure of the peak of the season - it is not strictly the maximum monthly, but rather the average of all months when considering months as an angle in the complex plane.  

### Seasonal Phase

```{r auseflux_nee_plots_phases}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_nee$comparisons[["Seasonal"]]
                                 , do.phase = TRUE
                                 , type = "values"
                                 , cuts = 0:12
                                 , override.cols = pals::ocean.phase(12)
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Phase Differences

```{r auseflux_nee_plots_phase_deltas}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_nee$comparisons[["Seasonal"]]
                                 , do.phase = TRUE
                                 , cuts = seq(-6, 6)
                                 , symmetric.scale = FALSE
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Seasonal Concentration

```{r auseflux_nee_plots_seasonal_concentration}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_nee$comparisons[["Seasonal"]]
                                 , type = "values"
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

### Concentration Differences

```{r auseflux_nee_plots_concentration_deltas}
if (do_auseflux_nee && settings$plot_maps) {
    plt <- plotSpatialComparison(auseflux_nee$comparisons[["Seasonal"]]
                                 , ncol = settings$num_cols
                                 , map.overlay = settings$map_overlay
                                 , text.multiplier = settings$text_multiplier
                                 , subtitle = auseflux_subtitle)
    print_plot(plt)
}
```

## {.unlisted .unnumbered}

<a href="#top">Back to top</a>

# Timing
Total run time:
``` {r time}
# report total run time
toc()
```
